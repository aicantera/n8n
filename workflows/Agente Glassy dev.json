{
  "createdAt": "2025-05-13T18:42:23.048Z",
  "updatedAt": "2025-06-30T22:02:01.000Z",
  "id": "GJUKvC12lo7L8JjK",
  "name": "Agente Glassy dev",
  "active": true,
  "nodes": [
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.message.text }}",
        "options": {
          "systemMessage": "=# Misión y Perfil del Agente\n\n- **Nombre del Agente:** Glassy\n- **Personalidad:** Eres un asistente virtual amable, amigable, servicial y muy profesional. Tu objetivo es ayudar a los usuarios de Glasbil.\n- **Fecha y Hora:** Hoy es `{{ $now.setZone('America/Mexico_City').minus({ hours: 2 }).setLocale('es').toFormat(\"dd 'de' LLLL 'de' ปี HH:mm:ss\") }}`.\n\n---\n\n# Directivas de Comportamiento\n\n1.  **Inicio de Conversación:** Al comenzar una nueva interacción, tu **primer** mensaje debe ser siempre: \"¡Hola! Soy Glassy, tu asistente virtual de Glasbil. Para darte una atención más personalizada, ¿cuál es tu nombre?\". Almacena el nombre del usuario para usarlo en la conversación. Si ya conoces el nombre, simplemente saluda y pregunta en qué puedes ayudar.\n\n2.  **Ámbito de Conocimiento:** Tu conocimiento se limita estrictamente a los siguientes temas. Utiliza la herramienta `kb_glasbil` para responder:\n    * Descripción de aditamentos\n    * Proceso de compra\n    * Horarios de atención\n    * Artículo para medios\n    * Historia de Glasbil\n    * Política de devolución\n    * Glosario\n    * Preguntas frecuentes\n\n3.  **Manejo de Información de Herramientas:** Cuando uses una herramienta (`kb_glasbil`, `codigos_postales`), indica al usuario que estás consultando la información. No leas la información textualmente; procesa y preséntala de forma clara y reformulada.\n\n4.  **Regla de Sustitución:** Siempre que encuentres la frase \"Recoger en Butik Morelia\" en la información de tus herramientas, debes cambiarla por \"Recoger en sucursal Butik Morelia\" en tu respuesta al usuario.\n\n5.  **Servicio a Domicilio y Códigos Postales:**\n    * Si el usuario pregunta genéricamente por tus servicios, describe los servicios principales (instalación, reparación) basándote en `kb_glasbil` **sin** mencionar los códigos postales.\n    * **ÚNICAMENTE** si el usuario pregunta explícitamente por \"instalación a domicilio\", \"cobertura\", \"zonas de servicio\" o un código postal específico, debes usar la herramienta `codigos_postales`.\n    * Al usar `codigos_postales`, presenta la lista completa de zonas y códigos postales cubiertos. No uses frases como \"entre otros\".\n\n6.  **Instalaciones y Reparaciones:**\n    * **Instalaciones:** Aclara que se realizan en la sucursal de Morelia y a domicilio, pero esto último solo dentro de la zona de cobertura que puedes consultar con tu herramienta `codigos_postales`.\n    * **Reparaciones (Daños, Grietas, Rayones):** Informa al usuario que para una reparación se requiere la valoración de un experto. Anímale a agendar una cita o solicitar más información a través de los canales de contacto. Ofrécele iniciar un proceso de cotización para su vehículo.\n\n7.  **Manejo de Preguntas Fuera de Alcance:** Si el usuario pregunta por algo fuera de tu ámbito de conocimiento (ej. llantas, retrovisores, temas no relacionados con Glasbil), responde con amabilidad que no tienes información sobre ese tema y proporciona inmediatamente las opciones de contacto.\n\n8.  **Escalación y Canales de Contacto (Fallback):** Cuando no tengas la información, necesites una valoración experta, o el usuario lo solicite, ofrece de forma clara y ordenada los siguientes medios de contacto:\n    * **Visítanos en sucursal:** Luis de León Romano 70, Nueva Valladolid, 58190 Morelia, Mich., México.\n    * **Llámanos:** 33 2592 1314\n    * **Escríbenos un correo:** hola@glasbil.com\n    * **Visita nuestro sitio web:** glasbil.com\n    * **Obtén una cotización detallada en línea:** butik-vidrio-v2.canteradigital.mx\n\n---\n\n# Flujo de Conversación: Proceso de Cotización\n\n**Objetivo:** Guiar al usuario paso a paso para recolectar la información necesaria y enviarla a través de la herramienta `agente_cotizzacion`. Sigue este proceso de forma estricta.\n\n**Paso 0: Activación**\nInicia este flujo únicamente si el usuario solicita explícitamente una \"cotización\", \"precio\", \"costo\" de un cristal, o si acepta tu sugerencia de cotizar después de hablar sobre una reparación.\n\n**Paso 1: Recopilar Datos del Vehículo**\nPregunta al usuario por los siguientes datos. Puedes pedirlos juntos o uno por uno. Si el usuario ya proporcionó alguno, no vuelvas a preguntarlo.\n- Año\n- Marca\n- Modelo\n\n**Paso 2: Obtener Tipos de Automóvil (sin Traducción)**\nUna vez que tengas año, marca y modelo, utiliza la herramienta `agente_cotizzacion` para obtener los \"tipos de automóvil\" disponibles.\n* **Acción:** Llama a `agente_cotizzacion` con la consulta: `solicita los tipos de automóvil disponibles para el año [año], la marca [marca] y el modelo [modelo]`.\n* **Interacción:** Muestra la lista de tipos en su idioma original al usuario y pídele que seleccione uno.\n\n**Paso 3: Obtener Tipos de Cristal (con Traducción)**\nCon el tipo de automóvil seleccionado, obtén la lista de cristales disponibles.\n* **Acción:**\n    1.  Llama a la herramienta `agente_cotizzacion` con la consulta: `solicita los tipos de cristales disponibles para el año [año], la marca [marca], el modelo [modelo] y el tipo de automóvil [tipo de automóvil]`.\n    2.  Define el siguiente **mapeo de traducción** para los términos de los cristales:\n        * `Windshield`: \"Parabrisas\"\n        * `Back glass`: \"Medallón (cristal trasero)\"\n        * `Side glass`: \"Cristal lateral (puertas)\"\n        * `Sunroof`: \"Quemacocos\"\n* **Interacción:** Muestra al usuario la lista de opciones usando los **términos en español** (ej. \"Parabrisas\", \"Medallón\", etc.) y pídele que seleccione uno.\n* **Lógica Interna:** Una vez que el usuario seleccione una opción en español, **debes guardar y utilizar el término correspondiente en inglés** (ej. si el usuario elige \"Parabrisas\", internamente usarás \"Windshield\") para los siguientes pasos.\n\n**Paso 4: Mostrar Productos Disponibles (con campos ocultos)**\nCon toda la información del vehículo y el tipo de cristal en inglés, busca los productos en existencia.\n* **Acción:** Llama a `agente_cotizzacion` con la consulta: `solicita los productos para el año [año], la marca [marca], el modelo [modelo], el tipo de automóvil [tipo de automóvil] y el tipo de cristal [tipo de cristal en INGLÉS obtenido del Paso 3]`.\n* **Interacción:** Muestra al usuario una lista numerada con el nombre (`product_name`) de cada producto encontrado. **Importante: Mostrar todos los campos con excepcion de \"Origen\", \"Precio\" y \"Existencias\" de los productos en esta lista.** Pídele al usuario que elija la opción que le interesa. Si no se encuentran productos, informa al usuario y ofrece ayuda a través de los canales de contacto.\n\n**Paso 5: Esperar Selección de Producto**\n* **Acción del Agente:** Esperar a que el usuario seleccione alguno de los productos en existencia de Glassbil para continuar con el siguiente paso de la cotización.\n\n**Paso 6: Recopilar Datos de Contacto**\n* **Acción del Agente:** Solicitar al usuario los siguientes datos de contacto:\n    - Nombre\n    - Teléfono\n    - Correo electrónico\n\n**Paso 7: Enviar Cotización Final**\nDe la información del producto seleccionado por el usuario, extrae la información requerida y envía la cotización.\n* **Acción:**\n    1.  Extrae `external_id`, `origin`, `nag` y `product_name` del producto seleccionado por el usuario en el paso 4 (aunque no se los hayas mostrado, tienes acceso a estos datos).\n    2.  Llama a la herramienta `agente_cotizzacion` con la consulta: `enviar la cotización para los siguientes datos de producto: año [año], marca [marca], modelo [modelo], tipo de automóvil [tipo], tipo de cristal [tipo de cristal en INGLÉS del Paso 3], external_id [id], origin [origen], nag [nag] y product_name [nombre_producto] y con los siguientes datos de contacto: contact_name [nombre_usuario], contact_phone [telefono_usuario] y contact_email [email_usuario]`.\n* **Confirmación:** Informa al usuario que su cotización ha sido enviada y que un experto se pondrá en contacto con él. Agradece su tiempo."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        60,
        300
      ],
      "id": "c3132aad-52a4-42b2-a3ce-a72bf44e86fc",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -100,
        560
      ],
      "id": "f271c3b9-05c9-4b9d-a090-d93e7d8d4632",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "zZlJrTGKq8KER7gD",
          "name": "OpenAi account - GLASSY"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1MdybkUkgnwvXUuGsbB2oNIUvkpGcyBw6RBvo199ZqK0",
          "mode": "list",
          "cachedResultName": "codigos postales atencion a clientes",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1MdybkUkgnwvXUuGsbB2oNIUvkpGcyBw6RBvo199ZqK0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Hoja 1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1MdybkUkgnwvXUuGsbB2oNIUvkpGcyBw6RBvo199ZqK0/edit#gid=0"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheetsTool",
      "typeVersion": 4.5,
      "position": [
        320,
        440
      ],
      "id": "e7c6c51c-2307-4f06-892e-723e2edc79fc",
      "name": "codigos_postales",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "VrznAZQXjQh9WpvY",
          "name": "Google Sheets - Cantera"
        }
      }
    },
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [
        -320,
        340
      ],
      "id": "25010742-83ee-405e-b067-fc8d69015662",
      "name": "Telegram Trigger",
      "webhookId": "bf50b0f2-f697-4702-8495-9979a1fb39e2",
      "credentials": {
        "telegramApi": {
          "id": "vcUHDLkV2ZD6YfU8",
          "name": "Telegram account - GLASSY"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "text": "={{ $json.output.replace(/\\*\\*(.*?)\\*\\*/g, '*$1*').replace(/([_()\\[\\]~`>#+\\-=|{}.!])/g, '\\\\$1') }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "MarkdownV2"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        760,
        340
      ],
      "id": "6bd6762b-3062-4722-8eb6-6e005313cd28",
      "name": "Telegram",
      "webhookId": "5949d845-75fd-4068-9ec9-3cf5d007ad55",
      "credentials": {
        "telegramApi": {
          "id": "vcUHDLkV2ZD6YfU8",
          "name": "Telegram account - GLASSY"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        480,
        620
      ],
      "id": "11d9eba2-17bb-41f8-b5aa-e51113fa6364",
      "name": "Embeddings OpenAI",
      "credentials": {
        "openAiApi": {
          "id": "zZlJrTGKq8KER7gD",
          "name": "OpenAi account - GLASSY"
        }
      }
    },
    {
      "parameters": {
        "mode": "retrieve-as-tool",
        "toolName": "kb_glasbil",
        "toolDescription": "aqui tienes toda la información de glasbil como:\npolitica de devolucion\ninformacion de aditamentos\npreguntas frecuentes\ndatos de contacto\ndirecciones\nglosario de terminos\nentre mas información disponible",
        "tableName": {
          "__rl": true,
          "value": "documents_glassy",
          "mode": "list",
          "cachedResultName": "documents_glassy"
        },
        "topK": 20,
        "options": {
          "queryName": "match_documents_glassy"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1.1,
      "position": [
        440,
        440
      ],
      "id": "bfa9675f-99e8-4e93-b795-c5fdbd45c993",
      "name": "kb_glasbil",
      "credentials": {
        "supabaseApi": {
          "id": "ty0KiXsEYP1uJ8t9",
          "name": "Supabase account - CANTERA"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.message.chat.id }}",
        "tableName": "n8n_chat_histories_glassy_dev",
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        20,
        660
      ],
      "id": "c5528067-6c86-492c-91f1-f7656a17fb42",
      "name": "Postgres Chat Memory",
      "credentials": {
        "postgres": {
          "id": "CFNWnFQx8hqQIegZ",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        20,
        100
      ],
      "id": "49eb8e8d-91a1-42a4-8075-1c316631c3aa",
      "name": "When clicking ‘Test workflow’"
    },
    {
      "parameters": {
        "operation": "deleteTable",
        "schema": {
          "__rl": true,
          "value": "public",
          "mode": "list",
          "cachedResultName": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_chat_histories_glassy_dev",
          "mode": "list",
          "cachedResultName": "n8n_chat_histories_glassy_dev"
        },
        "deleteCommand": "drop",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        240,
        100
      ],
      "id": "24bdcbaa-9af0-4b79-b06d-3b6e0ea3d557",
      "name": "Postgres",
      "credentials": {
        "postgres": {
          "id": "CFNWnFQx8hqQIegZ",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "description": "Tienes a la mano un agente que te ayuda a consultar la siguiente información necesaria para realizar una cotización:\n- Año\n- Marca\n- Modelo\n- tipo de vehículo\n- Tipo de cristal\n- Productos en existencia\n\nY dar de alta cotizaciones, solo necesitas mandarle la información correcta",
        "workflowId": {
          "__rl": true,
          "value": "4QLd4KoP0XGafQmk",
          "mode": "list",
          "cachedResultName": "Agente cotizados glasbil dev"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        260,
        640
      ],
      "id": "95886a4e-f941-4d88-8b12-5bd59b17ea65",
      "name": "agente_cotizzacion"
    },
    {
      "parameters": {
        "description": "Tu trabajo es asegurarte de que en el proceso de cotización el agente no muestre una respuesta que no haya consultado de la herramienta 'agente_cotizzacion'. Es importante que nunca inventes datos, siempre deberás consultarlos."
      },
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1,
      "position": [
        120,
        620
      ],
      "id": "7ea39b59-2b7f-4cdf-a48f-b70973ac2b1a",
      "name": "Think"
    },
    {
      "parameters": {
        "method": "POST",
        "url": " https://butik-vidrio.canteradigital.mx/api/productsNotFound/guest",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "brand",
              "value": "="
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [
        380,
        740
      ],
      "id": "19515bb6-b84a-4b47-b298-444055b4f517",
      "name": "crear cotizacion externa",
      "disabled": true
    }
  ],
  "connections": {
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "codigos_postales": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI": {
      "ai_embedding": [
        [
          {
            "node": "kb_glasbil",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "kb_glasbil": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "When clicking ‘Test workflow’": {
      "main": [
        [
          {
            "node": "Postgres",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "agente_cotizzacion": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Think": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "crear cotizacion externa": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {},
  "versionId": "5e32d3a6-a874-478e-9bba-34decb94959a",
  "triggerCount": 1,
  "shared": [
    {
      "createdAt": "2025-05-13T18:42:23.050Z",
      "updatedAt": "2025-05-13T18:42:23.050Z",
      "role": "workflow:owner",
      "workflowId": "GJUKvC12lo7L8JjK",
      "projectId": "BZ9Ta5yhe4RhzY78",
      "project": {
        "createdAt": "2025-05-13T15:56:28.209Z",
        "updatedAt": "2025-05-13T16:18:54.372Z",
        "id": "BZ9Ta5yhe4RhzY78",
        "name": "CANTERA ADMIN <canteradigital7@gmail.com>",
        "type": "personal",
        "icon": null,
        "projectRelations": [
          {
            "createdAt": "2025-05-13T15:56:28.209Z",
            "updatedAt": "2025-05-13T15:56:28.209Z",
            "role": "project:personalOwner",
            "userId": "cc3cfe5e-ee8c-4740-93d3-7cf7143ccce3",
            "projectId": "BZ9Ta5yhe4RhzY78",
            "user": {
              "createdAt": "2025-05-13T15:56:27.880Z",
              "updatedAt": "2025-05-27T17:38:25.272Z",
              "id": "cc3cfe5e-ee8c-4740-93d3-7cf7143ccce3",
              "email": "canteradigital7@gmail.com",
              "firstName": "CANTERA",
              "lastName": "ADMIN",
              "personalizationAnswers": {
                "version": "v4",
                "personalization_survey_submitted_at": "2025-05-13T16:19:25.161Z",
                "personalization_survey_n8n_version": "1.92.2",
                "companySize": "<20",
                "companyType": "saas",
                "role": "customer-support",
                "reportedSource": "event"
              },
              "settings": {
                "userActivated": true,
                "firstSuccessfulWorkflowId": "PTbESRzX3rguwQN8",
                "userActivatedAt": 1747154580970,
                "easyAIWorkflowOnboarded": true,
                "npsSurvey": {
                  "responded": true,
                  "lastShownAt": 1748367494893
                }
              },
              "role": "global:owner",
              "disabled": false,
              "mfaEnabled": false,
              "isPending": false,
              "isOwner": true
            }
          }
        ]
      }
    }
  ],
  "tags": [
    {
      "createdAt": "2025-05-13T18:42:21.332Z",
      "updatedAt": "2025-05-13T18:42:21.332Z",
      "id": "XE33dAVH8p6eXZMD",
      "name": "AGENTE GLASSY"
    }
  ]
}