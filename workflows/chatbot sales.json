{
  "createdAt": "2025-06-24T22:28:19.611Z",
  "updatedAt": "2025-07-03T18:00:32.341Z",
  "id": "PetXIW4fDRVoHgK5",
  "name": "chatbot sales",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "currentEnvironment",
              "value": "https://cerebro-dev-7d8f30a4b3ff.herokuapp.com"
            },
            {
              "name": "status_report",
              "value": "https://cerebro-core-050afed4ca53.herokuapp.com/sma/receive_messagebird_data"
            }
          ]
        },
        "options": {}
      },
      "name": "Set Variables",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [
        -80,
        100
      ],
      "id": "1ec9ea27-083f-478a-9832-0d65cd17fe52"
    },
    {
      "parameters": {
        "url": "={{$node[\"Set Variables\"].json[\"currentEnvironment\"]}}/mbauth/auth_guardian?phone={{ $('WhatsApp Trigger').item.json.messages[0].from }}",
        "options": {}
      },
      "name": "Auth Guardian",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        -740,
        -1480
      ],
      "id": "9d3bc755-2ee3-4071-b7bb-d9b014d12eac"
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $json.number_students }}",
              "operation": "largerEqual",
              "value2": 1
            }
          ]
        }
      },
      "name": "IF - Auth Success",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -520,
        -1480
      ],
      "id": "b21651bb-836f-4a74-b3aa-af4318763127"
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "group",
              "value": "={{ $('Auth Guardian').item.json.students_data[0].courses[0].group }}"
            },
            {
              "name": "guardian_name",
              "value": "={{ $('Auth Guardian').item.json.students_data[0].guardian_name }}"
            },
            {
              "name": "role",
              "value": "={{ $('Auth Guardian').item.json.students_data[0].role }}"
            },
            {
              "name": "school_section",
              "value": "={{ $('Auth Guardian').item.json.students_data[0].courses[0].school_section }}"
            },
            {
              "name": "student_name",
              "value": "={{ $('Auth Guardian').item.json.students_data[0].student_name }}"
            },
            {
              "name": "tenant_id",
              "value": "={{ $('Auth Guardian').item.json.students_data[0].tenant_id }}"
            },
            {
              "name": "user_id",
              "value": "={{ $('Auth Guardian').item.json.students_data[0].user_id }}"
            },
            {
              "name": "year",
              "value": "={{ $('Auth Guardian').item.json.students_data[0].courses[0].year }}"
            },
            {
              "name": "school_name",
              "value": "={{ $('Auth Guardian').item.json.students_data[0].school_name }}"
            },
            {
              "name": "feature"
            },
            {
              "name": "validated_whatsapp",
              "value": "={{ $('Auth Guardian').item.json.validated_whatsapp }}"
            }
          ],
          "boolean": [
            {
              "name": "multi_student",
              "value": "={{ $('Auth Guardian').item.json.multi_student }}"
            }
          ]
        },
        "options": {}
      },
      "name": "Main Logic Placeholder",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [
        -740,
        -1220
      ],
      "id": "03048936-dfd8-4ed9-8cbd-91d7db7e218e"
    },
    {
      "parameters": {
        "collection": "user_state_sales",
        "options": {},
        "query": "={\n  \"phoneNumber\":\"{{ $('WhatsApp Trigger').item.json.messages[0].from }}\"\n}"
      },
      "type": "n8n-nodes-base.mongoDb",
      "typeVersion": 1.1,
      "position": [
        140,
        100
      ],
      "id": "6e1e51a1-9cf2-44ba-90c9-75840a766f59",
      "name": "MongoDB",
      "alwaysOutputData": true,
      "credentials": {
        "mongoDb": {
          "id": "xZYe0R0CRtWFmyv7",
          "name": "MongoDB account cerebro core"
        }
      },
      "notes": "sdi no encuentras datos lanza un mensaje de no data returned"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "83be55d6-1bd8-4380-93b4-de2dd522cec4",
              "leftValue": "={{ $json._id.toString() }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        360,
        100
      ],
      "id": "98d74155-a71e-4404-b051-9e8f9f9385f9",
      "name": "If"
    },
    {
      "parameters": {
        "operation": "insert",
        "collection": "user_state_sales",
        "fields": "=phoneNumber ,state, userStateId, date, type_conversation",
        "options": {}
      },
      "type": "n8n-nodes-base.mongoDb",
      "typeVersion": 1.1,
      "position": [
        1240,
        200
      ],
      "id": "ae77e6a6-ecf2-4fe5-bb61-b5a0906b4aff",
      "name": "MongoDB1",
      "credentials": {
        "mongoDb": {
          "id": "xZYe0R0CRtWFmyv7",
          "name": "MongoDB account cerebro core"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "3631f4b8-c7de-42ac-a953-b78f8b10b879",
              "name": "phoneNumber",
              "value": "={{ $('WhatsApp Trigger').item.json.messages[0].from }}",
              "type": "string"
            },
            {
              "id": "961af1d0-8fba-486d-b2ff-5acdf1625b55",
              "name": "state",
              "value": "menuInicial",
              "type": "string"
            },
            {
              "id": "5c9e798a-8608-42b9-9270-1f7f94f9cff8",
              "name": "userStateId",
              "value": "={{ $json.uuid }}",
              "type": "string"
            },
            {
              "id": "2dcff05b-66b8-45a5-abc6-c4fa9f78c174",
              "name": "date",
              "value": "={{ $json.now }}",
              "type": "string"
            },
            {
              "id": "cf0f54d3-8433-4a11-9d75-9815e05a876a",
              "name": "type_conversation",
              "value": "chatbot",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1020,
        200
      ],
      "id": "8c6b9021-6a79-42c7-b056-76633cf40d7c",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "updates": [
          "messages"
        ],
        "options": {}
      },
      "type": "n8n-nodes-base.whatsAppTrigger",
      "typeVersion": 1,
      "position": [
        -740,
        -300
      ],
      "id": "11077335-da47-487d-aebb-39c1d3e75a1c",
      "name": "WhatsApp Trigger",
      "webhookId": "79902303-7c8b-4b2f-b91e-30dfa471b049",
      "credentials": {
        "whatsAppTriggerApi": {
          "id": "4llLGy8ampInXpaG",
          "name": "WhatsApp OAuth account cerebro sales"
        }
      }
    },
    {
      "parameters": {
        "collection": "user_state_sales",
        "options": {},
        "query": "={\n  \"phoneNumber\":\"{{ $('WhatsApp Trigger').item.json.messages[0].from }}\"\n}"
      },
      "type": "n8n-nodes-base.mongoDb",
      "typeVersion": 1.1,
      "position": [
        1460,
        200
      ],
      "id": "0fbb77d5-28a4-4e8c-9f5b-4adb7815ef65",
      "name": "MongoDB2",
      "alwaysOutputData": true,
      "credentials": {
        "mongoDb": {
          "id": "xZYe0R0CRtWFmyv7",
          "name": "MongoDB account cerebro core"
        }
      },
      "notes": "sdi no encuentras datos lanza un mensaje de no data returned"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "e1c21e64-5126-4a0c-a594-363efc7028d1",
              "name": "phoneNumber_finded",
              "value": "={{ $('MongoDB').item.json.phoneNumber }}",
              "type": "string"
            },
            {
              "id": "93580ec9-264e-4176-bc40-b50aaf34e1f2",
              "name": "state_finded",
              "value": "={{ $('MongoDB').item.json.state }}",
              "type": "string"
            },
            {
              "id": "ea7c6241-4996-49e5-8eea-1e84ac3d27d1",
              "name": "type_conversation_finded",
              "value": "={{ $('MongoDB').item.json.type_conversation }}",
              "type": "string"
            },
            {
              "id": "baefc287-abc1-42da-ace7-65a6859a8e25",
              "name": "student_selected",
              "value": "={{ $json.student_id }}",
              "type": "string"
            },
            {
              "id": "192aa38a-3a34-4956-aa99-29730cc29e9c",
              "name": "user_id_finded",
              "value": "={{ $('MongoDB').item.json.userStateId }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1680,
        0
      ],
      "id": "d0d2813b-75ac-4160-9527-f42875feafc2",
      "name": "Edit Fields1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "e1c21e64-5126-4a0c-a594-363efc7028d1",
              "name": "phoneNumber_edited",
              "value": "={{ $json.phoneNumber }}",
              "type": "string"
            },
            {
              "id": "93580ec9-264e-4176-bc40-b50aaf34e1f2",
              "name": "state_edited",
              "value": "={{ $json.state }}",
              "type": "string"
            },
            {
              "id": "78d840a2-ae29-44c0-b0fc-1dcd3b44ff00",
              "name": "type_conversation_edited",
              "value": "={{ $json.type_conversation }}",
              "type": "string"
            },
            {
              "id": "a3888bbd-713a-45ba-883d-997e16a38877",
              "name": "user_state_edited",
              "value": "={{ $('MongoDB1').item.json.userStateId }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1680,
        200
      ],
      "id": "7700298c-8e36-48f0-80ee-dd78bbec5ce5",
      "name": "Edit Fields2"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.messages[0].audio.voice }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "exists",
                      "singleValue": true
                    },
                    "id": "1d07820e-eba7-477b-9d97-b7eafab2b218"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "mensaje de voz"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "1af6c276-b636-440b-bbe5-cbc837091bd2",
                    "leftValue": "={{ $json.messages[0].type }}",
                    "rightValue": "document",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "documento"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "5618e653-a507-4ea4-979f-00b7f2b130d9",
                    "leftValue": "={{ $json.messages[0].type }}",
                    "rightValue": "image",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "imagen"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "da89dce8-8fe7-4db2-8fdf-ec07c5275504",
                    "leftValue": "={{ $json.messages[0].type }}",
                    "rightValue": "video",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "video"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "cb6a1619-9e4f-4fb1-ada2-ddbc8d0e9bc3",
                    "leftValue": "={{ $json.messages[0].type }}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "texto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "8bb0b189-ee63-4c74-aaaf-62d744854522",
                    "leftValue": "={{ $json.messages[0].interactive.type }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "exists",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "mensaje replica"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -300,
        -363
      ],
      "id": "03b380d2-f30f-4499-aa9e-aeb762ad48ef",
      "name": "Switch1",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $('Variables Wp').item.json.clienteIdWp }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('Variables Wp').item.json.tokenWp }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('WhatsApp Trigger').item.json.messages[0].from }}\",\n  \"text\": \"interactive\",\n  \"text\": {\n    \"body\": \"Lo siento, en este momento no tengo la capacidad de interpretar notas de voz. Sin embargo, estamos trabajando para incluir esta función en futuras actualizaciones.  Gracias por tu comprensión.\"\n  }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -80,
        -700
      ],
      "id": "a36dae75-551f-4c17-a6bb-93e548ee9625",
      "name": "Error mensaje de voz"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $('Variables Wp').item.json.clienteIdWp }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('Variables Wp').item.json.tokenWp }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('WhatsApp Trigger').item.json.messages[0].from }}\",\n  \"text\": \"interactive\",\n  \"text\": {\n    \"body\": \"Lo siento, en este momento no tengo la capacidad de interpretar archivos. Gracias por tu comprensión.\"\n  }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -80,
        -500
      ],
      "id": "7d158440-f31f-4b59-9d80-647e262b91a7",
      "name": "error documento"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $('Variables Wp').item.json.clienteIdWp }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('Set Variables').item.json.tokenWp }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('WhatsApp Trigger').item.json.messages[0].from }}\",\n  \"text\": \"interactive\",\n  \"text\": {\n    \"body\": \"Lo siento, en este momento no tengo la capacidad de interpretar imagenes. Sin embargo, estamos trabajando para incluir esta función en futuras actualizaciones. Gracias por tu comprensión.\"\n  }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -80,
        -300
      ],
      "id": "86316b3c-416c-4e62-a3a2-f74266a1b459",
      "name": "error imagen"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $('Variables Wp').item.json.clienteIdWp }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('Set Variables').item.json.tokenWp }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('WhatsApp Trigger').item.json.messages[0].from }}\",\n  \"text\": \"interactive\",\n  \"text\": {\n    \"body\": \"Lo siento, en este momento no tengo la capacidad de interpretar notas de voz. Sin embargo, estamos trabajando para incluir esta función en futuras actualizaciones.  Gracias por tu comprensión.\"\n  }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -80,
        -100
      ],
      "id": "e2e03cba-2df8-4df8-b216-34e0666c5fb3",
      "name": "error video"
    },
    {
      "parameters": {
        "jsCode": "// Importante: Esto se coloca dentro de un nodo \"Code\" en n8n\n\nfunction uuidv4() {\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n    const r = Math.random() * 16 | 0;\n    const v = c === 'x' ? r : (r & 0x3 | 0x8);\n    return v.toString(16);\n  });\n}\n\nreturn [\n  {\n    json: {\n      uuid: uuidv4(),\n      now: new Date().toLocaleString('es-MX', {\n  timeZone: 'America/Mexico_City'\n})\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        800,
        200
      ],
      "id": "74a3b06d-dfc7-4c8f-a3c8-8027c500cc31",
      "name": "Code",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "9b562075-a550-4abf-b109-c329dec77be5",
              "leftValue": "={{ $json.type_conversation_finded || $json.type_conversation_edited }}",
              "rightValue": "chatbot",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2120,
        100
      ],
      "id": "7f8dff70-c405-4787-bf48-3d95a12e225f",
      "name": "If9"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "9b562075-a550-4abf-b109-c329dec77be5",
              "leftValue": "={{ $json.type_conversation_edited }}",
              "rightValue": "chatbot",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -740,
        -1740
      ],
      "id": "0be26412-6bb9-46e2-b176-bbb8ab2ffefb",
      "name": "If10"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $('Set Variables').item.json.clienteIdWp }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('Set Variables').item.json.tokenWp }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"status\":\"read\",\n  \"message_id\":\"{{ $('WhatsApp Trigger').item.json.messages[0].id }}\",\n  \"typing_indicator\": {\n    \"type\":\"text\"\n  }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1460,
        0
      ],
      "id": "38cea0e7-13ee-4c20-b3aa-710cbd6478f1",
      "name": "typing indicator1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $('Variables Wp').item.json.clienteIdWp }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('Set Variables').item.json.tokenWp }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"status\":\"read\",\n  \"message_id\":\"{{ $('WhatsApp Trigger').item.json.messages[0].id }}\",\n  \"typing_indicator\": {\n    \"type\":\"text\"\n  }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        580,
        200
      ],
      "id": "31d483d2-54bc-4e54-bb3a-443243c1e8b4",
      "name": "typing indicator2"
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "clienteIdWp",
              "value": "669848086217681"
            },
            {
              "name": "tokenWp",
              "value": "Bearer EAAUX8tBNibUBO5oRM8xn7QQMJ949BYO49fUoAtXQZBkvdNqCZAbZC4sHTXZC0wyUBMLT2CvP0GpNdSaF3yd0F43HZC7m6ubsYitZBvzksq11tqPZC8omLgJlj5kSPHjhT1sIod9jsuW9z2i0rGu2xmIp7WD9I6ZCUhosuM31ANSp1tI554IQQbSVAyoIvoI6B1rohwZDZD"
            },
            {
              "name": "tenant_id",
              "value": "fe8f5abe-abda-4223-8ab0-c81247aa9cec"
            }
          ]
        },
        "options": {}
      },
      "name": "Variables Wp",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [
        -520,
        -300
      ],
      "id": "8cbd6a37-2a04-42b2-be31-90976fa13006"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.state_edited ? $json.state_edited : $json.state_finded}}",
                    "rightValue": "menuInicial",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "67ada602-4a37-408f-880d-29a2c0a2964d"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "menu inicial"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "49660bd6-0c53-49b6-a272-353eae4acf80",
                    "leftValue": "={{ $json.state_edited ? $json.state_edited : $json.state_finded}}",
                    "rightValue": "esperando_respuesta_menu_inicial",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "espera_respuesta_menu_inicial"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "e63b8bcb-ffae-47fd-be83-4460047ee4f3",
                    "leftValue": "={{ $json.state_edited ? $json.state_edited : $json.state_finded}}",
                    "rightValue": "esperando_respuesta_menu_informes",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "rsp_informes"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "faed8982-b54d-4cc9-85df-45c31ad392ec",
                    "leftValue": "={{ $json.state_edited ? $json.state_edited : $json.state_finded}}",
                    "rightValue": "esperando_respuesta_dia_cita",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "cita_rsp"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "5d560ba0-a11a-45f3-9d2d-d13049d4df4c",
                    "leftValue": "={{ $json.state_edited ? $json.state_edited : $json.state_finded}}",
                    "rightValue": "esperando_respuesta_menu_costos",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "rsp_costos"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "7ba99368-0eb6-48ed-af01-77c7c4768b41",
                    "leftValue": "={{ $json.state_edited ? $json.state_edited : $json.state_finded}}",
                    "rightValue": "esperando_respuesta_menu_contacto_costos",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "contacto costos"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "2d803248-e0f9-4478-8ff0-768db480b95d",
                    "leftValue": "={{ $json.state_edited ? $json.state_edited : $json.state_finded}}",
                    "rightValue": "espera_respuesta_evento_informacion_calendario",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "mas info evento calendario"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "5f2b8eb8-dca7-40cc-9d86-1ed8f85b1027",
                    "leftValue": "={{ $json.state_edited ? $json.state_edited : $json.state_finded}}",
                    "rightValue": "espera_respuesta_academico",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "resp academico"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "c17a27fb-f67a-48af-ab13-a78c9f77e4f8",
                    "leftValue": "={{ $json.state_edited ? $json.state_edited : $json.state_finded}}",
                    "rightValue": "espera_respuesta_informacion_academico",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "re_inf_academico"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "e897eb9e-7845-4596-b7e4-6e6299e2de6c",
                    "leftValue": "={{ $json.state_edited ? $json.state_edited : $json.state_finded}}",
                    "rightValue": "proceso_justificacion",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "justificacion"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "59c5aacd-d431-4d88-a74c-4511477b8cfa",
                    "leftValue": "={{ $json.state_edited ? $json.state_edited : $json.state_finded}}",
                    "rightValue": "proceso_calificaciones_estudiante",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "calificaciones"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        2340,
        -68
      ],
      "id": "6b61f4d1-58b2-48fe-b95c-ec8eedb5d012",
      "name": "Switch"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "670342e3-e699-4e30-af27-04db7bace385",
              "name": "user_id",
              "value": "={{ $('flujo de actualización base de datos').item.json.userId }}",
              "type": "string"
            },
            {
              "id": "391a519a-9e7c-4dee-8dfc-f8b38f7f8fc7",
              "name": "information",
              "value": "={{ $('flujo de actualización base de datos').item.json.info }}",
              "type": "string"
            },
            {
              "id": "915b68b5-3dee-44ad-82f6-65a3d9a74629",
              "name": "log_id",
              "value": "={{ $('Code1').item.json.uuid }}",
              "type": "string"
            },
            {
              "id": "f07b7183-62a0-4d4a-90a7-ad93e7acd220",
              "name": "date",
              "value": "={{ $('Code1').item.json.now }}",
              "type": "string"
            },
            {
              "id": "e5baae19-924c-4972-8a51-b4d87aad8bad",
              "name": "state",
              "value": "={{ $('flujo de actualización base de datos').item.json.state }}",
              "type": "string"
            },
            {
              "id": "127efdf6-7193-4011-a155-fa072b66e80f",
              "name": "userStateId",
              "value": "={{ $('flujo de actualización base de datos').item.json.userStateId }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        140,
        -960
      ],
      "id": "2707c8fa-70dc-41a5-956b-a5ffad36ec7a",
      "name": "Edit Fields3"
    },
    {
      "parameters": {
        "operation": "insert",
        "collection": "log_chatbot_sales",
        "fields": "user_id, information,log_id, date",
        "options": {}
      },
      "type": "n8n-nodes-base.mongoDb",
      "typeVersion": 1.1,
      "position": [
        360,
        -960
      ],
      "id": "3f1045c2-13c4-420d-8df6-06ced704adff",
      "name": "MongoDB4",
      "credentials": {
        "mongoDb": {
          "id": "xZYe0R0CRtWFmyv7",
          "name": "MongoDB account cerebro core"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Importante: Esto se coloca dentro de un nodo \"Code\" en n8n\n\nfunction uuidv4() {\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n    const r = Math.random() * 16 | 0;\n    const v = c === 'x' ? r : (r & 0x3 | 0x8);\n    return v.toString(16);\n  });\n}\n\nreturn [\n  {\n    json: {\n      uuid: uuidv4(),\n      now: new Date().toLocaleString('es-MX', {\n  timeZone: 'America/Mexico_City'\n})\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -520,
        -960
      ],
      "id": "714361d5-b6bb-4f46-aee9-34ff13710712",
      "name": "Code1",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "operation": "update",
        "collection": "user_state_sales",
        "updateKey": "userStateId",
        "fields": "state, date",
        "options": {}
      },
      "type": "n8n-nodes-base.mongoDb",
      "typeVersion": 1.1,
      "position": [
        -80,
        -960
      ],
      "id": "8c3b9bc5-82ec-49c2-b3c1-351516f79c48",
      "name": "MongoDB5",
      "credentials": {
        "mongoDb": {
          "id": "xZYe0R0CRtWFmyv7",
          "name": "MongoDB account cerebro core"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "f07b7183-62a0-4d4a-90a7-ad93e7acd220",
              "name": "date",
              "value": "={{ $('Code1').item.json.now }}",
              "type": "string"
            },
            {
              "id": "e5baae19-924c-4972-8a51-b4d87aad8bad",
              "name": "state",
              "value": "={{ $('flujo de actualización base de datos').item.json.state }}",
              "type": "string"
            },
            {
              "id": "127efdf6-7193-4011-a155-fa072b66e80f",
              "name": "userStateId",
              "value": "={{ $('flujo de actualización base de datos').item.json.userStateId }}",
              "type": "string"
            },
            {
              "id": "3cdecd72-e504-4219-92a9-223f2c61783a",
              "name": "sub_menu",
              "value": "={{ $('flujo de actualización base de datos').item.json.sub_menu }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -300,
        -960
      ],
      "id": "cb12897e-213d-41b1-930e-bf71480dc920",
      "name": "Edit Fields4"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "PetXIW4fDRVoHgK5",
          "mode": "list",
          "cachedResultName": "chatbot sales"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "state": "esperando_respuesta_menu_inicial",
            "userStateId": "={{ $json.userStateId }}",
            "userId": "={{ $json.userId }}",
            "info": "={{ $json.info }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "userId",
              "displayName": "userId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "userStateId",
              "displayName": "userStateId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "info",
              "displayName": "info",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        4100,
        -2280
      ],
      "id": "db2c5269-a65d-4cbd-ba77-02377e42e985",
      "name": "Execute Workflow"
    },
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "state"
            },
            {
              "name": "userId"
            },
            {
              "name": "userStateId"
            },
            {
              "name": "info"
            },
            {
              "name": "sub_menu"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -740,
        -960
      ],
      "id": "c4cc66de-e835-4e05-8941-1674ed6d7741",
      "name": "flujo de actualización base de datos"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "a91ed21b-1b4c-40c7-9fdb-b98f3ad8d94b",
              "leftValue": "={{ $('Code2').item.json.user_state_final }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3680,
        -2160
      ],
      "id": "70814299-a8f6-4d6c-82b3-e2eeecc92625",
      "name": "revisamos si ya existia"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "cb5bf561-971f-493b-8312-772ff7f21da3",
              "name": "userStateId",
              "value": "={{ $('Code2').item.json.user_state_final }}",
              "type": "string"
            },
            {
              "id": "1356aa24-d7f3-4700-9568-aa9b6ece9b4c",
              "name": "info",
              "value": "se presenta menú inicial",
              "type": "string"
            },
            {
              "id": "6b9a8f55-16af-4e52-b897-0ac1cfca6083",
              "name": "userId",
              "value": "={{ $('Code2').item.json.user_id_finded || $('Code2').item.json.user_id_edited }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3880,
        -2280
      ],
      "id": "f077b3b3-bd2e-4f68-9176-5800a3cdc48a",
      "name": "Edit Fields5"
    },
    {
      "parameters": {
        "jsCode": "// Function node\nconst idInsertado  = $json.user_id_finded;             // viene de la rama de insert\nconst idActualizado = $json.user_state_edited;      // viene de la rama de update\nreturn [{ json: {\n  ...$json,\n  user_state_final: idActualizado || idInsertado,\n}}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1900,
        100
      ],
      "id": "edec0766-ea03-4223-84c9-0e8491026044",
      "name": "Code2"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.selection }}",
                    "rightValue": 1,
                    "operator": {
                      "type": "number",
                      "operation": "equals"
                    },
                    "id": "6f7b2060-af41-4559-bbfb-7ac41ceb3091"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "información"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "5a969ce2-2d9e-400d-9058-e9686ab50d02",
                    "leftValue": "={{ $json.selection }}",
                    "rightValue": 2,
                    "operator": {
                      "type": "number",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Citas"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        5100,
        -2600
      ],
      "id": "bfea1332-db16-4ee4-a51f-7c1b159fe33f",
      "name": "Switch2"
    },
    {
      "parameters": {
        "jsCode": "// Nodo “Function” de n8n\n// Valida items[0].json.selection y retorna status con mensajes amistosos\n\n// 1. Leer la selección del nodo Set anterior\nconst raw = items[0].json.selection;\nconst sel = Number(raw);\n\n// 2. Preparar la respuesta con mensajes descriptivos\nlet result;\n\nif (Number.isNaN(sel)) {\n  // No es un número\n  result = {\n    status: 'error',\n    message: `Ups, parece que tu elección “${raw}” no es un número. Por favor escribe un número del 1 al 7 para continuar.`\n  };\n} else if (!Number.isInteger(sel)) {\n  // No es entero\n  result = {\n    status: 'error',\n    message: `Veo que has ingresado ${sel}, pero necesitamos un número entero. Por favor elige un número sin decimales entre 1 y 7.`\n  };\n} else if (sel < 1 || sel > 7) {\n  // Fuera de rango\n  result = {\n    status: 'error',\n    message: `Tu selección es ${sel}, pero debe estar entre 1 y 7. Intenta de nuevo con un número dentro de ese rango.`\n  };\n} else {\n  // OK\n  result = {\n    status: 'success',\n    message: `¡Genial! Has seleccionado la opción número ${sel}.`,\n    selection: sel\n  };\n}\n\n// 3. Devolver el resultado para usar en nodos siguientes\nreturn [\n  {\n    json: result\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3900,
        -1720
      ],
      "id": "9f7cee82-f0b6-4236-bd99-6c13c07d0951",
      "name": "Code3"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "967bc904-1e28-4f4e-af20-bde631bb863a",
              "name": "selection",
              "value": "={{ $('WhatsApp Trigger').item.json.messages[0].text.body }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3640,
        -1720
      ],
      "id": "44caa38a-faf3-4977-b7ee-b1736bc294b9",
      "name": "obtenemos la respuesta del menu inicial"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "1b2792b2-4d4e-4e50-af12-cb3d4c3e0e08",
              "leftValue": "={{ $json.status }}",
              "rightValue": "success",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        4120,
        -1720
      ],
      "id": "afe4f66b-e131-494e-9415-67bfe5886956",
      "name": "verificamos que la seleccion sea valida"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $('Variables Wp').item.json.clienteIdWp }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('Variables Wp').item.json.tokenWp }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('WhatsApp Trigger').item.json.messages[0].from }}\",\n  \"text\": \"interactive\",\n  \"text\": {\n    \"body\": \"{{ $json.message }}\"\n  }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4360,
        -1700
      ],
      "id": "3ff2f6dd-cf7b-4737-80dc-bf2f831a01ea",
      "name": "Error seleccion menu invalida"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        4580,
        -1700
      ],
      "id": "623335ff-8469-4170-a97f-e249ae8b38f7",
      "name": "No Operation, do nothing"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $('Variables Wp').item.json.clienteIdWp }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('Variables Wp').item.json.tokenWp }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('WhatsApp Trigger').item.json.messages[0].from }}\",\n  \"text\": \"interactive\",\n  \"text\": {\n    \"body\": \"Nos ubicamos en 📍Av. Cafetales 233, Coapa, Tlalpan, CDMX. A un lado del centro de entrenamiento Nelson Vargas. \\n\\n¿Para qué sección estás interesado? \\n\\nEscribe el número de la opción que deseas:\\n\\n1️⃣ Preescolar\\n2️⃣ Primaria \\n3️⃣ Secundaria\\n4️⃣ Bachillerato \\n5️⃣ La ubicación no me queda\"\n  }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6280,
        -1400
      ],
      "id": "534ac9e6-3f4e-43e6-ad26-c280eb6ac82e",
      "name": "envio de mensaje ubicación"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "PetXIW4fDRVoHgK5",
          "mode": "list",
          "cachedResultName": "chatbot sales"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "state": "esperando_respuesta_menu_ubicacion",
            "userStateId": "={{ $json.userStateId }}",
            "userId": "={{ $json.userId }}",
            "info": "={{ $json.info }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "userId",
              "displayName": "userId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "userStateId",
              "displayName": "userStateId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "info",
              "displayName": "info",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        6680,
        -1400
      ],
      "id": "40198380-24dc-4fc3-8c6b-a7f86f6360ff",
      "name": "Execute Workflow1",
      "disabled": true
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "cb5bf561-971f-493b-8312-772ff7f21da3",
              "name": "userStateId",
              "value": "={{ $('Code2').item.json.user_state_final }}",
              "type": "string"
            },
            {
              "id": "1356aa24-d7f3-4700-9568-aa9b6ece9b4c",
              "name": "info",
              "value": "se presenta ubicación y menú",
              "type": "string"
            },
            {
              "id": "6b9a8f55-16af-4e52-b897-0ac1cfca6083",
              "name": "userId",
              "value": "={{ $('Code2').item.json.user_id_finded || $('Code2').item.json.user_id_edited }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6500,
        -1400
      ],
      "id": "53b0a1f3-6429-4275-bea6-806adf88504b",
      "name": "body datos ubicacion"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "PetXIW4fDRVoHgK5",
          "mode": "list",
          "cachedResultName": "chatbot sales"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "state": "esperando_respuesta_menu_costos",
            "userStateId": "={{ $json.userStateId }}",
            "userId": "={{ $json.userId }}",
            "info": "={{ $json.info }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "userId",
              "displayName": "userId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "userStateId",
              "displayName": "userStateId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "info",
              "displayName": "info",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        6740,
        -1200
      ],
      "id": "317d7de1-3be6-4ea1-8936-fd94951c0415",
      "name": "Execute Workflow2"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "cb5bf561-971f-493b-8312-772ff7f21da3",
              "name": "userStateId",
              "value": "={{ $('Code2').item.json.user_state_final }}",
              "type": "string"
            },
            {
              "id": "1356aa24-d7f3-4700-9568-aa9b6ece9b4c",
              "name": "info",
              "value": "se presenta costos y menú",
              "type": "string"
            },
            {
              "id": "6b9a8f55-16af-4e52-b897-0ac1cfca6083",
              "name": "userId",
              "value": "={{ $('Code2').item.json.user_id_finded || $('Code2').item.json.user_id_edited }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6520,
        -1200
      ],
      "id": "4dd81662-7e81-46eb-bb22-1b65041dac53",
      "name": "body datos costos"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "PetXIW4fDRVoHgK5",
          "mode": "list",
          "cachedResultName": "chatbot sales"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "state": "esperando_respuesta_menu_horario",
            "userStateId": "={{ $json.userStateId }}",
            "userId": "={{ $json.userId }}",
            "info": "={{ $json.info }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "userId",
              "displayName": "userId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "userStateId",
              "displayName": "userStateId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "info",
              "displayName": "info",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        6740,
        -1000
      ],
      "id": "13217905-8dce-4ec6-965d-c4010cbc6ac0",
      "name": "Execute Workflow3",
      "disabled": true
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "cb5bf561-971f-493b-8312-772ff7f21da3",
              "name": "userStateId",
              "value": "={{ $('Code2').item.json.user_state_final }}",
              "type": "string"
            },
            {
              "id": "1356aa24-d7f3-4700-9568-aa9b6ece9b4c",
              "name": "info",
              "value": "se presenta horario extendido y menú",
              "type": "string"
            },
            {
              "id": "6b9a8f55-16af-4e52-b897-0ac1cfca6083",
              "name": "userId",
              "value": "={{ $('Code2').item.json.user_id_finded || $('Code2').item.json.user_id_edited }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6520,
        -1000
      ],
      "id": "eb87b902-9a49-485c-bd9f-780d663200ad",
      "name": "body datos costos1"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "PetXIW4fDRVoHgK5",
          "mode": "list",
          "cachedResultName": "chatbot sales"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "state": "esperando_respuesta_menu_horario",
            "userStateId": "={{ $json.userStateId }}",
            "userId": "={{ $json.userId }}",
            "info": "={{ $json.info }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "userId",
              "displayName": "userId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "userStateId",
              "displayName": "userStateId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "info",
              "displayName": "info",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        6740,
        -820
      ],
      "id": "5c393447-19be-4ba5-a6d4-558cf57ce1f9",
      "name": "Execute Workflow4",
      "disabled": true
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "cb5bf561-971f-493b-8312-772ff7f21da3",
              "name": "userStateId",
              "value": "={{ $('Code2').item.json.user_state_final }}",
              "type": "string"
            },
            {
              "id": "1356aa24-d7f3-4700-9568-aa9b6ece9b4c",
              "name": "info",
              "value": "se presenta horario extendido y menú",
              "type": "string"
            },
            {
              "id": "6b9a8f55-16af-4e52-b897-0ac1cfca6083",
              "name": "userId",
              "value": "={{ $('Code2').item.json.user_id_finded || $('Code2').item.json.user_id_edited }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6520,
        -820
      ],
      "id": "c59506fd-b9ae-4cbb-956f-66fea1e948f2",
      "name": "body datos costos2"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "PetXIW4fDRVoHgK5",
          "mode": "list",
          "cachedResultName": "chatbot sales"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "state": "esperando_respuesta_menu_horario",
            "userStateId": "={{ $json.userStateId }}",
            "userId": "={{ $json.userId }}",
            "info": "={{ $json.info }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "userId",
              "displayName": "userId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "userStateId",
              "displayName": "userStateId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "info",
              "displayName": "info",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        6740,
        -660
      ],
      "id": "9458b8f3-ebee-4d81-9d4a-05140d58b98b",
      "name": "Execute Workflow5",
      "disabled": true
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "cb5bf561-971f-493b-8312-772ff7f21da3",
              "name": "userStateId",
              "value": "={{ $('Code2').item.json.user_state_final }}",
              "type": "string"
            },
            {
              "id": "1356aa24-d7f3-4700-9568-aa9b6ece9b4c",
              "name": "info",
              "value": "se presenta horario extendido y menú",
              "type": "string"
            },
            {
              "id": "6b9a8f55-16af-4e52-b897-0ac1cfca6083",
              "name": "userId",
              "value": "={{ $('Code2').item.json.user_id_finded || $('Code2').item.json.user_id_edited }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6520,
        -660
      ],
      "id": "df57bd22-a620-4084-9c39-e4689dc8fe11",
      "name": "body datos costos3"
    },
    {
      "parameters": {
        "jsCode": "// 1. Leer la selección del nodo Set anterior\nconst raw = items[0].json.selection;\nconst sel = parseInt(raw, 10);\n\n// 2. Preparar la respuesta con mensajes descriptivos y mapeo de tipos\nlet result;\n\nif (isNaN(sel)) {\n  // No es un número\n  result = {\n    status: 'error',\n    message: `Ups, parece que tu elección “${raw}” no es un número. Por favor escribe un número del 1 al 5 para continuar.`\n  };\n} else if (!Number.isInteger(sel)) {\n  // No es entero\n  result = {\n    status: 'error',\n    message: `Veo que has ingresado ${raw}, pero necesitamos un número entero. Por favor elige un número sin decimales entre 1 y 5.`\n  };\n} else if (sel < 1 || sel > 5) {\n  // Fuera de rango\n  result = {\n    status: 'error',\n    message: `Tu selección es ${sel}, pero debe estar entre 1 y 5. Intenta de nuevo con un número dentro de ese rango.`\n  };\n} else {\n  // OK: asignar tipo según selección\n  const typeMap = {\n    1: 'maternal',\n    2: 'preescolar',\n    3: 'primaria',\n    4: 'secundaria',\n    5: 'bachillerato',\n  };\n  result = {\n    status: 'success',\n    message: `¡Genial! Has seleccionado la opción número ${sel}.`,\n    selection: sel,\n    type: typeMap[sel],\n  };\n}\n\n// 3. Devolver el resultado para usar en nodos siguientes\nreturn [\n  {\n    json: result\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5000,
        480
      ],
      "id": "a7afe98b-490b-4535-814d-edec5edaf877",
      "name": "Code4"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "1b2792b2-4d4e-4e50-af12-cb3d4c3e0e08",
              "leftValue": "={{ $json.status }}",
              "rightValue": "success",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        5220,
        480
      ],
      "id": "c5f9bd5c-a751-4e44-8c26-c296803b1a6d",
      "name": "verificamos que la seleccion sea valida1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $('Variables Wp').item.json.clienteIdWp }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('Variables Wp').item.json.tokenWp }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('WhatsApp Trigger').item.json.messages[0].from }}\",\n  \"text\": \"interactive\",\n  \"text\": {\n    \"body\": \"{{ $json.message }}\"\n  }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5460,
        500
      ],
      "id": "27d2d750-962a-4428-8bd3-bb6122635bcf",
      "name": "Error seleccion menu invalida1"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        5680,
        500
      ],
      "id": "be451cd9-1c33-412c-8e88-ab687df04b11",
      "name": "No Operation, do nothing1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "967bc904-1e28-4f4e-af20-bde631bb863a",
              "name": "selection",
              "value": "={{ $('WhatsApp Trigger').item.json.messages[0].text.body }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        4740,
        480
      ],
      "id": "3ed5b812-09b7-49cd-9392-c8993c8e9f5f",
      "name": "obtenemos la respuesta del menu costos"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "87b55870-39a9-4fe9-a45f-220115821760",
              "leftValue": "={{ $json.selection }}",
              "rightValue": 6,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        7540,
        -480
      ],
      "id": "b80d1be7-a3e9-4931-8431-26c7603f3b3c",
      "name": "validamos si se selecciono menu anterior desde costos"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.selection }}",
                    "rightValue": 1,
                    "operator": {
                      "type": "number",
                      "operation": "equals"
                    },
                    "id": "6f7b2060-af41-4559-bbfb-7ac41ceb3091"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "maternal"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "5a969ce2-2d9e-400d-9058-e9686ab50d02",
                    "leftValue": "={{ $json.selection }}",
                    "rightValue": 2,
                    "operator": {
                      "type": "number",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "preescolar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "dd4a50a5-f08c-4bf7-b9c2-7d4626ba2cc2",
                    "leftValue": "={{ $json.selection }}",
                    "rightValue": 3,
                    "operator": {
                      "type": "number",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "primaria"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "5e69f0a7-cb9f-4330-99d2-e637322242a1",
                    "leftValue": "={{ $json.selection }}",
                    "rightValue": 4,
                    "operator": {
                      "type": "number",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "secundaria"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "3812c246-c17e-4583-8a0f-e0117828aca1",
                    "leftValue": "={{ $json.selection }}",
                    "rightValue": 5,
                    "operator": {
                      "type": "number",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "bachillerato"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        7800,
        -500
      ],
      "id": "ea01d23c-df13-4225-95d5-7d719dc4d6cd",
      "name": "Switch3"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "PetXIW4fDRVoHgK5",
          "mode": "list",
          "cachedResultName": "chatbot sales"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "state": "esperando_respuesta_menu_contacto_costos",
            "userStateId": "={{ $json.userStateId }}",
            "userId": "={{ $json.userId }}",
            "info": "={{ $json.info }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "userId",
              "displayName": "userId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "userStateId",
              "displayName": "userStateId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "info",
              "displayName": "info",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        9340,
        -460
      ],
      "id": "1d386c50-7770-4e0b-a307-149d26caafc0",
      "name": "Execute Workflow6",
      "disabled": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $('Variables Wp').item.json.clienteIdWp }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('Variables Wp').item.json.tokenWp }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('WhatsApp Trigger').item.json.messages[0].from }}\",\n  \"type\": \"image\",\n  \"image\": {\n    \"link\": \"https://wbyyuljmsumarxassthc.supabase.co/storage/v1/object/public/cerebro-storage-sales/fe8f5abe-abda-4223-8ab0-c81247aa9cec/sales_repo/20250703_093707_costo_maternal.jpeg\",\n    \"caption\": \"Queremos conocerte y presentarte nuestro proyecto!\\n*Costos sujetos a ajuste sin previo aviso\\n\\nConoce nuestro proyecto\\nhttps://www.colegioreims.edu.mx/proyecto-educativo\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        8280,
        -760
      ],
      "id": "b88d9328-e2f9-4585-a92c-259e22ff9652",
      "name": "info costo maternal"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $('Variables Wp').item.json.clienteIdWp }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('Variables Wp').item.json.tokenWp }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('WhatsApp Trigger').item.json.messages[0].from }}\",\n  \"type\": \"image\",\n  \"image\": {\n    \"link\": \"https://wbyyuljmsumarxassthc.supabase.co/storage/v1/object/public/cerebro-storage-sales/fe8f5abe-abda-4223-8ab0-c81247aa9cec/sales_repo/20250703_093906_costo_preescolar.jpeg\",\n    \"caption\": \"Queremos conocerte y presentarte nuestro proyecto!\\n*Costos sujetos a ajuste sin previo aviso\\n\\nConoce nuestro proyecto\\nhttps://www.colegioreims.edu.mx/proyecto-educativo\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        8280,
        -600
      ],
      "id": "c70e5a13-42a0-4dd8-bbe4-f5dc97a6a007",
      "name": "info costo pre escolar"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $('Variables Wp').item.json.clienteIdWp }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('Variables Wp').item.json.tokenWp }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('WhatsApp Trigger').item.json.messages[0].from }}\",\n  \"type\": \"image\",\n  \"image\": {\n    \"link\": \"https://wbyyuljmsumarxassthc.supabase.co/storage/v1/object/public/cerebro-storage-sales/fe8f5abe-abda-4223-8ab0-c81247aa9cec/sales_repo/20250703_095307_costo_primaria.jpeg\",\n    \"caption\": \"Queremos conocerte y presentarte nuestro proyecto!\\n*Costos sujetos a ajuste sin previo aviso\\n\\nConoce nuestro proyecto\\nhttps://www.colegioreims.edu.mx/proyecto-educativo\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        8280,
        -440
      ],
      "id": "62e53aef-f6b2-4891-b39b-f7c467a065c5",
      "name": "info costo primaria"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $('Variables Wp').item.json.clienteIdWp }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('Variables Wp').item.json.tokenWp }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('WhatsApp Trigger').item.json.messages[0].from }}\",\n  \"type\": \"image\",\n  \"image\": {\n    \"link\": \"https://wbyyuljmsumarxassthc.supabase.co/storage/v1/object/public/cerebro-storage-sales/fe8f5abe-abda-4223-8ab0-c81247aa9cec/sales_repo/20250703_095437_costo_secundaria.jpeg\",\n    \"caption\": \"Queremos conocerte y presentarte nuestro proyecto!\\n*Costos sujetos a ajuste sin previo aviso\\n\\nConoce nuestro proyecto\\nhttps://www.colegioreims.edu.mx/proyecto-educativo\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        8280,
        -280
      ],
      "id": "177be801-3376-4fe1-8a3d-2fce3528c251",
      "name": "info costo secundaria"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $('Variables Wp').item.json.clienteIdWp }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('Variables Wp').item.json.tokenWp }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('WhatsApp Trigger').item.json.messages[0].from }}\",\n  \"type\": \"image\",\n  \"image\": {\n    \"link\": \"https://wbyyuljmsumarxassthc.supabase.co/storage/v1/object/public/cerebro-storage-sales/fe8f5abe-abda-4223-8ab0-c81247aa9cec/sales_repo/20250703_095613_costo_bachillerato.jpeg\",\n    \"caption\": \"Queremos conocerte y presentarte nuestro proyecto!\\n*Costos sujetos a ajuste sin previo aviso\\n\\nConoce nuestro proyecto\\nhttps://www.colegioreims.edu.mx/proyecto-educativo\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        8280,
        -120
      ],
      "id": "b23116b8-10a3-469a-97aa-8bd63b4fd461",
      "name": "info costo bachillerato"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $('Variables Wp').item.json.clienteIdWp }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('Variables Wp').item.json.tokenWp }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('WhatsApp Trigger').item.json.messages[0].from }}\",\n  \"text\": \"interactive\",\n  \"text\": {\n    \"body\": \"Selecciona la opción deseada escribiendo el número:\\n1️⃣ Sí, quiero hablar con alguien!\\n2️⃣ Muchas gracias, por el momento es todo\"\n  }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        8880,
        -460
      ],
      "id": "a9234e23-113c-407d-9ab9-a8e0a1020910",
      "name": "envio de mensaje contacto costos"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "cb5bf561-971f-493b-8312-772ff7f21da3",
              "name": "userStateId",
              "value": "={{ $('Code2').item.json.user_state_final }}",
              "type": "string"
            },
            {
              "id": "1356aa24-d7f3-4700-9568-aa9b6ece9b4c",
              "name": "info",
              "value": "=se presenta informacion de costo {{ $('Code4').item.json.type }}",
              "type": "string"
            },
            {
              "id": "6b9a8f55-16af-4e52-b897-0ac1cfca6083",
              "name": "userId",
              "value": "={{ $('Code2').item.json.user_id_finded || $('Code2').item.json.user_id_edited }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        9120,
        -460
      ],
      "id": "d3ea2255-7841-4ada-8323-27783d4e98d6",
      "name": "body datos contacto costos"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "PetXIW4fDRVoHgK5",
          "mode": "list",
          "cachedResultName": "chatbot sales"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "state": "esperando_respuesta_menu_inicial",
            "userStateId": "={{ $json.userStateId }}",
            "userId": "={{ $json.userId }}",
            "info": "={{ $json.info }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "userId",
              "displayName": "userId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "userStateId",
              "displayName": "userStateId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "info",
              "displayName": "info",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        3160,
        740
      ],
      "id": "de903a34-fda7-491f-b785-2195d922039f",
      "name": "Execute Workflow7",
      "disabled": true
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "cb5bf561-971f-493b-8312-772ff7f21da3",
              "name": "userStateId",
              "value": "={{ $('Code2').item.json.user_state_final }}",
              "type": "string"
            },
            {
              "id": "1356aa24-d7f3-4700-9568-aa9b6ece9b4c",
              "name": "info",
              "value": "se presentan opciones de contacto para costos",
              "type": "string"
            },
            {
              "id": "6b9a8f55-16af-4e52-b897-0ac1cfca6083",
              "name": "userId",
              "value": "={{ $('Code2').item.json.user_id_finded || $('Code2').item.json.user_id_edited }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2900,
        740
      ],
      "id": "fa3bb810-bec0-4007-86f7-844a97030ed2",
      "name": "Edit Fields6"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $('Variables Wp').item.json.clienteIdWp }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('Variables Wp').item.json.tokenWp }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('WhatsApp Trigger').item.json.messages[0].from }}\",\n  \"text\": \"interactive\",\n  \"text\": {\n    \"body\": \"{{ $json.message }}\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3940,
        520
      ],
      "id": "4f171c7e-846e-4964-853c-64394fe782c1",
      "name": "Error mensaje contacto costos"
    },
    {
      "parameters": {
        "content": "## Primer menú para el cliente\n* Aquí se seleccionan datos de informacion, costos, direccion, contactos entre otras cosas *\nHola! Bienvenid@ al Colegio Reims! 😃\n\n¿En qué te podemos ayudar? Escribe el número de la opción que deseas: \n1️⃣ Informes\n2️⃣ Ubicación \n\n\n\n\n// anterior\n1️⃣ Ubicación\n2️⃣ Costos \n3️⃣ Horario Extendido\n4️⃣ Programa Bilingüe\n5️⃣ Contáctame 📲\n\n6️⃣ Gracias, ya estoy hablando con un asesor ✅\n",
        "height": 1140,
        "width": 1360
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        3080,
        -3000
      ],
      "typeVersion": 1,
      "id": "62df9d47-0fa6-43ce-85b0-4fdeeb4ee4bb",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "## Respuesta al menú de costos\n** aquí se presentan las opciones para los costos de los diferentes tipos de servicios que se ofrecen **\n¿Para qué grado estás interesad@? Escribe el número de la opción que deseas:\n1️⃣ Maternal\n2️⃣ Preescolar\n3️⃣ Primaria\n4️⃣ Secundaria\n5️⃣ Bachillerato\n\n-----------------------------------------------------\n\n6️⃣  Regresar al menú anterior:",
        "height": 960,
        "width": 1860,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        7080,
        -920
      ],
      "typeVersion": 1,
      "id": "ac2d81ae-ab3f-4180-963d-c06e170d6d1a",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "content": "## Pasos para la entrada del usuario\n**En esta parte se verifica si el usuario es nuevo o ya tiene una convertsación iniciada**",
        "height": 1280,
        "width": 3180
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -400,
        -780
      ],
      "typeVersion": 1,
      "id": "9374c8ca-a6f2-4032-ba04-2d2bbfbcc6a7",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "5a969ce2-2d9e-400d-9058-e9686ab50d02",
                    "leftValue": "={{ $json.selection }}",
                    "rightValue": 1,
                    "operator": {
                      "type": "number",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ubicación"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "dd4a50a5-f08c-4bf7-b9c2-7d4626ba2cc2",
                    "leftValue": "={{ $json.selection }}",
                    "rightValue": 2,
                    "operator": {
                      "type": "number",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "costos"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "5e69f0a7-cb9f-4330-99d2-e637322242a1",
                    "leftValue": "={{ $json.selection }}",
                    "rightValue": 3,
                    "operator": {
                      "type": "number",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "horario extendido"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "3812c246-c17e-4583-8a0f-e0117828aca1",
                    "leftValue": "={{ $json.selection }}",
                    "rightValue": 4,
                    "operator": {
                      "type": "number",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "bilingue"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "5a785880-a238-46e6-8136-51648cfe3639",
                    "leftValue": "={{ $json.selection }}",
                    "rightValue": 5,
                    "operator": {
                      "type": "number",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "contactame"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        5680,
        -880
      ],
      "id": "5921e1e5-b69d-4f22-9e43-cfcbc9ae173b",
      "name": "Switch4"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $('Variables Wp').item.json.clienteIdWp }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('Variables Wp').item.json.tokenWp }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('WhatsApp Trigger').item.json.messages[0].from }}\",\n  \"text\": \"interactive\",\n  \"text\": {\n    \"body\": \"Hola! Bienvenid@ al Colegio Reims! 😃\\n\\n¿En qué te podemos ayudar? Escribe el número de la opción que deseas: \\n\\n1️⃣ Informes\\n2️⃣ Citas\"\n  }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3460,
        -2160
      ],
      "id": "82f639a3-d94d-4dfd-979c-7b3170f9b635",
      "name": "Mensaje menu inicial"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $('Variables Wp').item.json.clienteIdWp }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('Variables Wp').item.json.tokenWp }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('WhatsApp Trigger').item.json.messages[0].from }}\",\n  \"text\": \"interactive\",\n  \"text\": {\n    \"body\": \"Gracias por solicitar información, ¿Sobre que necesitas saber?\\n\\n1️⃣ Ubicación\\n2️⃣ Costos \\n3️⃣ Horario Extendido\\n4️⃣ Programa Bilingüe\\n5️⃣ Contáctame 📲\\n\\n6️⃣ Gracias, ya estoy hablando con un asesor ✅\"\n  }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5520,
        -2920
      ],
      "id": "e8c40544-7e42-4734-8f46-99657fc61a97",
      "name": "Mensaje menu información"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "PetXIW4fDRVoHgK5",
          "mode": "list",
          "cachedResultName": "chatbot sales"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "state": "esperando_respuesta_menu_informes",
            "userStateId": "={{ $json.userStateId }}",
            "userId": "={{ $json.userId }}",
            "info": "={{ $json.info }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "userId",
              "displayName": "userId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "userStateId",
              "displayName": "userStateId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "info",
              "displayName": "info",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        5920,
        -2920
      ],
      "id": "1e54dff7-f359-472d-8742-d8dc0d07b6bb",
      "name": "Execute Workflow8"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "cb5bf561-971f-493b-8312-772ff7f21da3",
              "name": "userStateId",
              "value": "={{ $('Code2').item.json.user_state_final }}",
              "type": "string"
            },
            {
              "id": "1356aa24-d7f3-4700-9568-aa9b6ece9b4c",
              "name": "info",
              "value": "se presenta menu de informes",
              "type": "string"
            },
            {
              "id": "6b9a8f55-16af-4e52-b897-0ac1cfca6083",
              "name": "userId",
              "value": "={{ $('Code2').item.json.user_id_finded || $('Code2').item.json.user_id_edited }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        5740,
        -2920
      ],
      "id": "12a9b213-23ee-4a16-9f29-90aff1bcafcd",
      "name": "body datos menu información"
    },
    {
      "parameters": {
        "jsCode": "// Nodo “Function” de n8n\n// Valida items[0].json.selection y retorna status con mensajes amistosos\n\n// 1. Leer la selección del nodo Set anterior\nconst raw = items[0].json.selection;\nconst sel = Number(raw);\n\n// 2. Preparar la respuesta con mensajes descriptivos\nlet result;\n\nif (Number.isNaN(sel)) {\n  // No es un número\n  result = {\n    status: 'error',\n    message: `Ups, parece que tu elección “${raw}” no es un número. Por favor escribe un número del 1 al 7 para continuar.`\n  };\n} else if (!Number.isInteger(sel)) {\n  // No es entero\n  result = {\n    status: 'error',\n    message: `Veo que has ingresado ${sel}, pero necesitamos un número entero. Por favor elige un número sin decimales entre 1 y 6.`\n  };\n} else if (sel < 1 || sel > 6) {\n  // Fuera de rango\n  result = {\n    status: 'error',\n    message: `Tu selección es ${sel}, pero debe estar entre 1 y 6. Intenta de nuevo con un número dentro de ese rango.`\n  };\n} else {\n  // OK\n  result = {\n    status: 'success',\n    message: `¡Genial! Has seleccionado la opción número ${sel}.`,\n    selection: sel\n  };\n}\n\n// 3. Devolver el resultado para usar en nodos siguientes\nreturn [\n  {\n    json: result\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3840,
        -1080
      ],
      "id": "dee5d6ec-1b49-4048-93c4-af91585d7652",
      "name": "Code5"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "967bc904-1e28-4f4e-af20-bde631bb863a",
              "name": "selection",
              "value": "={{ $('WhatsApp Trigger').item.json.messages[0].text.body }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3580,
        -1080
      ],
      "id": "e92e68fd-fa61-4266-bd27-ce1f140dd140",
      "name": "obtenemos la respuesta del menu inicial1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "1b2792b2-4d4e-4e50-af12-cb3d4c3e0e08",
              "leftValue": "={{ $json.status }}",
              "rightValue": "success",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        4060,
        -1080
      ],
      "id": "7033fa3e-af6c-4b08-8c30-789292335ce7",
      "name": "verificamos que la seleccion sea valida2"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $('Variables Wp').item.json.clienteIdWp }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('Variables Wp').item.json.tokenWp }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('WhatsApp Trigger').item.json.messages[0].from }}\",\n  \"text\": \"interactive\",\n  \"text\": {\n    \"body\": \"{{ $json.message }}\"\n  }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4380,
        -1080
      ],
      "id": "8ecc907d-1dac-4b77-9a78-2ffb6bd9cd1e",
      "name": "Error seleccion menu invalida2"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        4600,
        -1080
      ],
      "id": "43d78ec7-0fcb-4307-b5a3-cdc67924b605",
      "name": "No Operation, do nothing2"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $('Variables Wp').item.json.clienteIdWp }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('Variables Wp').item.json.tokenWp }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('WhatsApp Trigger').item.json.messages[0].from }}\",\n  \"text\": \"interactive\",\n  \"text\": {\n    \"body\": \"¿Para qué grado estás interesad@? Escribe el número de la opción que deseas:\\n1️⃣ Maternal\\n2️⃣ Preescolar\\n3️⃣ Primaria\\n4️⃣ Secundaria\\n5️⃣ Bachillerato\\n\\n-----------------------------------------------------\\n\\n6️⃣  Regresar al menú anterior:\"\n  }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6280,
        -1200
      ],
      "id": "21276aeb-dd6f-431b-a022-b2b305f1b7f2",
      "name": "envio de mensaje costo"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $('Variables Wp').item.json.clienteIdWp }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('Variables Wp').item.json.tokenWp }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('WhatsApp Trigger').item.json.messages[0].from }}\",\n  \"text\": \"interactive\",\n  \"text\": {\n    \"body\": \"Nuestro colegio cuenta con horario extendido hasta las 18:00 hrs.\\nDurante este horario los alumnos pueden comer, tomar una actividad deportiva, taller de tareas, certificaciones de inglés y más 😉 🔝\\nPara conocer las actividades que se ofrecen te invitamos a consultar el siguiente documento:\\nhttps://www.colegioreims.edu.mx/actividades-extraescolares\\nPermite que uno de nuestros especialistas te contacte para darte más información sobre nuestro proyecto educativo.\\nSelecciona la opción deseada escribiendo el número:\\n1️⃣ Sí, quiero hablar con alguien!\\n2️⃣ Muchas gracias, por el momento es todo\"\n  }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6280,
        -1000
      ],
      "id": "fdaa6942-a1b6-47cf-9935-b5ea30e65146",
      "name": "envio de mensaje horario"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $('Variables Wp').item.json.clienteIdWp }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('Variables Wp').item.json.tokenWp }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('WhatsApp Trigger').item.json.messages[0].from }}\",\n  \"text\": \"interactive\",\n  \"text\": {\n    \"body\": \"Nuestro colegio ofrece inglés para todos los niveles.\\nA partir de Preprimaria (4 años) hasta 6to de primaria los alumn@s tienen mitad del día inglés y mitad del día español.\\nSecundaria y Bachillerato toman las clases por niveles y un aproximado de 5 hrs por semana.\\nTenemos certificaciones con Cambridge English:\\n🔴 Key (KET) ó A2 Key 🔵 Preliminary (PET) ó B1 Preliminary 🔴 First (FCE) ó B2 First 🔵 Advanced (CAE)\"\n  }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6280,
        -820
      ],
      "id": "f75385ae-59ea-4183-8b60-f038121efcdc",
      "name": "envio de mensaje bilingüe"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $('Variables Wp').item.json.clienteIdWp }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('Variables Wp').item.json.tokenWp }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('WhatsApp Trigger').item.json.messages[0].from }}\",\n  \"text\": \"interactive\",\n  \"text\": {\n    \"body\": \"Te gustaría una llamada telefónica para platicarte de nuestro Proyecto Educativo o Agendar una visita? Escribe el número de la opción que deseas: \\n\\n1️⃣ Llamada telefónica \\n2️⃣ Agendar visita \\n------------------------------------------------------\\n3️⃣ Regresar al menú anterior\"\n  }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6280,
        -660
      ],
      "id": "5d83ee6b-c89f-4982-8e76-b3e4ba480349",
      "name": "envio de mensaje contactame"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "7de3bb2b-748d-4491-8fd4-8953493f36a3",
              "leftValue": "={{ $json.selection }}",
              "rightValue": 6,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        4020,
        -1320
      ],
      "id": "97db9c00-8dc4-4d31-b2e3-50a458d6f73e",
      "name": "revisamos que ya esta hablando con alguien"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $('Variables Wp').item.json.clienteIdWp }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('Variables Wp').item.json.tokenWp }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('WhatsApp Trigger').item.json.messages[0].from }}\",\n  \"text\": \"interactive\",\n  \"text\": {\n    \"body\": \"¡Perfecto! Me alegra saber que ya estás en contacto. Si necesitas algo más, aquí estoy. 😊\"\n  }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6760,
        -2140
      ],
      "id": "f1e19fa5-1f69-43f2-becd-6d93d0aa014f",
      "name": "Error seleccion menu invalida3"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "PetXIW4fDRVoHgK5",
          "mode": "list",
          "cachedResultName": "chatbot sales"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "state": "menuInicial",
            "userStateId": "={{ $json.userStateId }}",
            "userId": "={{ $json.userId }}",
            "info": "={{ $json.info }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "userId",
              "displayName": "userId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "userStateId",
              "displayName": "userStateId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "info",
              "displayName": "info",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "sub_menu",
              "displayName": "sub_menu",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        7200,
        -2140
      ],
      "id": "07862417-f5a2-4629-8e79-8d2e6dcf74ba",
      "name": "Execute Workflow9"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "cb5bf561-971f-493b-8312-772ff7f21da3",
              "name": "userStateId",
              "value": "={{ $('Code2').item.json.user_state_final }}",
              "type": "string"
            },
            {
              "id": "1356aa24-d7f3-4700-9568-aa9b6ece9b4c",
              "name": "info",
              "value": "el usuario ya esta hablando con un asesor",
              "type": "string"
            },
            {
              "id": "6b9a8f55-16af-4e52-b897-0ac1cfca6083",
              "name": "userId",
              "value": "={{ $('Code2').item.json.user_id_finded || $('Code2').item.json.user_id_edited }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6980,
        -2140
      ],
      "id": "2420f821-7e2b-412e-a4eb-9de37899b467",
      "name": "body datos costos4"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Set Variables').item.json.currentEnvironment }}/sales/available-slots-chatbot",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"tenant_id\": \"{{ $('Variables Wp').item.json.tenant_id }}\",\n  \"current_datetime\": \"{{ \n  (() => {\n    const d = new Date();\n    const pad = n => n.toString().padStart(2,'0');\n    return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;\n  })()\n}}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5520,
        -2460
      ],
      "id": "f54bd586-11d6-4572-adea-5b23219499ef",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $('Variables Wp').item.json.clienteIdWp }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('Variables Wp').item.json.tokenWp }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('WhatsApp Trigger').item.json.messages[0].from }}\",\n  \"text\": \"interactive\",\n  \"text\": {\n    \"body\": \"{{ $json.whatsapp_message.replace(/\\r?\\n/g, \"\\\\n\").replace(/^\\\\n+|\\\\n+$/g, \"\") }}\"\n  }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5760,
        -2460
      ],
      "id": "7e8100f5-ecb0-4e6d-959a-e316ac9eabab",
      "name": "Mensaje menu información1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $('Variables Wp').item.json.clienteIdWp }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('Variables Wp').item.json.tokenWp }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('WhatsApp Trigger').item.json.messages[0].from }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"body\": {\n      \"text\": \"Para regresar, pulsa Menú anterior\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"menu_anterior\",\n            \"title\": \"Menú anterior\"\n          }\n        }\n      ]\n    }\n  }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5960,
        -2460
      ],
      "id": "1b269b42-4d40-4159-82b0-277a2ae92a27",
      "name": "menu principal4"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "PetXIW4fDRVoHgK5",
          "mode": "list",
          "cachedResultName": "chatbot sales"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "state": "esperando_respuesta_dia_cita",
            "userStateId": "={{ $json.userStateId }}",
            "userId": "={{ $json.userId }}",
            "info": "={{ $json.info }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "userId",
              "displayName": "userId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "userStateId",
              "displayName": "userStateId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "info",
              "displayName": "info",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "sub_menu",
              "displayName": "sub_menu",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        6380,
        -2460
      ],
      "id": "0cbd2232-12ce-4008-a72c-83787f7125b2",
      "name": "Execute Workflow10"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "cb5bf561-971f-493b-8312-772ff7f21da3",
              "name": "userStateId",
              "value": "={{ $('Code2').item.json.user_state_final }}",
              "type": "string"
            },
            {
              "id": "1356aa24-d7f3-4700-9568-aa9b6ece9b4c",
              "name": "info",
              "value": "se presentan horarios de citas disponibles ",
              "type": "string"
            },
            {
              "id": "6b9a8f55-16af-4e52-b897-0ac1cfca6083",
              "name": "userId",
              "value": "={{ $('Code2').item.json.user_id_finded || $('Code2').item.json.user_id_edited }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6160,
        -2460
      ],
      "id": "a5d2ada4-6a50-4d78-99e3-8b2b25a3e82e",
      "name": "body datos menu información1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "e734ff39-596a-4ecf-a624-74aa06e0cfb8",
              "leftValue": "={{ $('WhatsApp Trigger').item.json.messages[0].type }}",
              "rightValue": "text",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3260,
        -80
      ],
      "id": "c02aabe9-94e3-4460-a8a6-f973c0a5e9b1",
      "name": "revisamos si viene boton de menu anterior"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Set Variables').item.json.currentEnvironment }}/sales/available-slots-chatbot",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"tenant_id\": \"{{ $('Variables Wp').item.json.tenant_id }}\",\n  \"current_datetime\": \"{{ \n  (() => {\n    const d = new Date();\n    const pad = n => n.toString().padStart(2,'0');\n    return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;\n  })()\n}}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3500,
        -60
      ],
      "id": "bd172ae7-3326-40d8-adaf-b95b1561b75a",
      "name": "HTTP Request2"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "476fc6ff-5525-40d1-a018-dac9c590f287",
              "name": "available_slots",
              "value": "={{ $json.available_slots }}",
              "type": "array"
            },
            {
              "id": "bcaa87d7-34f9-47b2-b2c2-cce72f7b4951",
              "name": "selection",
              "value": "={{ $('WhatsApp Trigger').item.json.messages[0].text.body }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3720,
        -60
      ],
      "id": "e4d470fe-858a-4334-8175-b6eb8d3ef6d5",
      "name": "datos para seleccionar dia de cita"
    },
    {
      "parameters": {
        "jsCode": "// 1) Leer del JSON de entrada\nconst { available_slots, selection } = items[0].json;\n\n// 2) Validar que selection sea un número\nconst sel = parseInt(selection, 10);\nif (isNaN(sel)) {\n  return [{\n    json: {\n      status: 'error',\n      message: `Ups, “${selection}” no es un número válido. Por favor responde con un número entre 1 y ${available_slots.length}.`\n    }\n  }];\n}\n\n// 3) Validar rango\nconst total = Array.isArray(available_slots) ? available_slots.length : 0;\nif (sel < 1 || sel > total) {\n  return [{\n    json: {\n      status: 'error',\n      message: `Tu selección es ${sel}, pero solo hay ${total} opciones. Elige un número entre 1 y ${total}.`\n    }\n  }];\n}\n\n// 4) Obtener el slot correspondiente (1 → índice 0)\nconst chosenSlot = available_slots[sel - 1];\n\n// 5) Devolver éxito con el slot seleccionado\nreturn [{\n  json: {\n    status: 'success',\n    message: `Has seleccionado la opción ${sel}. Aquí los datos del espacio:`,\n    selected_slot: chosenSlot\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3940,
        -60
      ],
      "id": "830cac52-39fc-4c39-bed5-e47c411b1a56",
      "name": "obtenemos el slot solicitado"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "c52600bf-d904-4d31-95ff-ab5e4f15bb0b",
              "leftValue": "={{ $json.status }}",
              "rightValue": "error",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        4160,
        -60
      ],
      "id": "faf5f785-5d80-4a20-a5aa-afb11205b286",
      "name": "If1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $('Variables Wp').item.json.clienteIdWp }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('Variables Wp').item.json.tokenWp }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('WhatsApp Trigger').item.json.messages[0].from }}\",\n  \"text\": \"interactive\",\n  \"text\": {\n    \"body\": \"{{ $json.message }}\"\n  }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4440,
        -80
      ],
      "id": "8e64b5d8-8633-4189-92dd-c322365ffbb8",
      "name": "error de seleccion de dia"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Set Variables').item.json.currentEnvironment }}/sales/book-appointment-chatbot",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"tenant_id\": \"{{ $('Variables Wp').item.json.tenant_id }}\",\n  \"phone_number\": \"{{ $('WhatsApp Trigger').item.json.messages[0].from }}\", \n  \"selection_number\": {{ $json.selected_slot.selection_number }},\n  \"selected_date\": \"{{ $json.selected_slot.date }}\",\n  \"selected_time\": \"{{ $json.selected_slot.start_time }}\",\n  \"vendor_id\": \"{{ $json.selected_slot.vendor_id }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4440,
        80
      ],
      "id": "5c47f6bc-5bb1-438d-bbdc-6d0c8e96711f",
      "name": "guardamos la cita",
      "alwaysOutputData": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "c63c1bd7-f4e4-49e4-a1dc-ed0eff1b97cb",
              "leftValue": "={{ $json.error }}",
              "rightValue": "",
              "operator": {
                "type": "object",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        4660,
        120
      ],
      "id": "dfc84381-8671-4dcc-a8d3-2df1dac4a128",
      "name": "verificamos que halla un error"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "PetXIW4fDRVoHgK5",
          "mode": "list",
          "cachedResultName": "chatbot sales"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "state": "menuInicial",
            "userStateId": "={{ $json.userStateId }}",
            "userId": "={{ $json.userId }}",
            "info": "={{ $json.info }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "userId",
              "displayName": "userId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "userStateId",
              "displayName": "userStateId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "info",
              "displayName": "info",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        5420,
        -20
      ],
      "id": "92f14855-16b5-4f6e-8d18-95a88e20721b",
      "name": "Execute Workflow11"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "cb5bf561-971f-493b-8312-772ff7f21da3",
              "name": "userStateId",
              "value": "={{ $('Code2').item.json.user_state_final }}",
              "type": "string"
            },
            {
              "id": "1356aa24-d7f3-4700-9568-aa9b6ece9b4c",
              "name": "info",
              "value": "Error en la cita",
              "type": "string"
            },
            {
              "id": "6b9a8f55-16af-4e52-b897-0ac1cfca6083",
              "name": "userId",
              "value": "={{ $('Code2').item.json.user_id_finded || $('Code2').item.json.user_id_edited }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        5200,
        -20
      ],
      "id": "e85d11b8-8ce0-4164-8296-bd0f5f894b87",
      "name": "body datos costos5"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $('Variables Wp').item.json.clienteIdWp }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('Variables Wp').item.json.tokenWp }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('WhatsApp Trigger').item.json.messages[0].from }}\",\n  \"text\": \"interactive\",\n  \"text\": {\n    \"body\": \"Lo siento, tu número telefónico no se encuentra registrado. Si necesitas más información, no dudes en contactarnos de nuevo.\"\n  }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4920,
        -20
      ],
      "id": "56adbac5-d7c1-41ec-9091-e421c6f5e880",
      "name": "error usuario no registrado"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $('Variables Wp').item.json.clienteIdWp }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('Variables Wp').item.json.tokenWp }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('WhatsApp Trigger').item.json.messages[0].from }}\",\n  \"text\": \"interactive\",\n  \"text\": {\n    \"body\": \"{{ $json.whatsapp_message.replace(/\\r?\\n/g, \"\\\\n\").replace(/^\\\\n+|\\\\n+$/g, \"\") }}\"\n  }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4920,
        200
      ],
      "id": "dad8e455-b6ec-4432-8b79-7582731ebb96",
      "name": "error usuario no registrado1"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "PetXIW4fDRVoHgK5",
          "mode": "list",
          "cachedResultName": "chatbot sales"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "state": "menuInicial",
            "userStateId": "={{ $json.userStateId }}",
            "userId": "={{ $json.userId }}",
            "info": "={{ $json.info }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "userId",
              "displayName": "userId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "userStateId",
              "displayName": "userStateId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "info",
              "displayName": "info",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        5380,
        200
      ],
      "id": "7032183b-4589-402b-86d1-345b842d07e6",
      "name": "Execute Workflow12"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "cb5bf561-971f-493b-8312-772ff7f21da3",
              "name": "userStateId",
              "value": "={{ $('Code2').item.json.user_state_final }}",
              "type": "string"
            },
            {
              "id": "1356aa24-d7f3-4700-9568-aa9b6ece9b4c",
              "name": "info",
              "value": "=Cita registrada {{ $('obtenemos el slot solicitado').item.json.selected_slot.date }} a las {{ $('obtenemos el slot solicitado').item.json.selected_slot.start_time }}",
              "type": "string"
            },
            {
              "id": "6b9a8f55-16af-4e52-b897-0ac1cfca6083",
              "name": "userId",
              "value": "={{ $('Code2').item.json.user_id_finded || $('Code2').item.json.user_id_edited }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        5180,
        200
      ],
      "id": "dc3dbb7a-b3c1-4bad-bf14-d47143661cce",
      "name": "body datos costos6"
    },
    {
      "parameters": {
        "amount": 2
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        8600,
        -460
      ],
      "id": "ef705569-e08c-41ca-99c0-3a99c170e012",
      "name": "Wait",
      "webhookId": "617ecd9c-79cd-4d58-aeaf-60948d8a7da5"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1f33c929-ae7b-4b64-a3f3-a3c2c7994d71",
              "name": "selection",
              "value": "={{ $('WhatsApp Trigger').item.json.messages[0].text.body }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2900,
        380
      ],
      "id": "1dbbb19e-5e77-48cf-8ea0-f755668e143d",
      "name": "tomamos la seleccion del usuario"
    },
    {
      "parameters": {
        "jsCode": "// Nodo “Function” de n8n\n\n// 1. Leer selección del nodo Set anterior\nconst raw = items[0].json.selection;\n// Intentamos convertirlo a número\nconst sel = Number(raw);\n\nlet result;\n\n// 2. Validaciones\nif (raw === undefined || raw === null) {\n  result = {\n    status: 'error',\n    message: 'No se proporcionó ninguna selección.'\n  };\n} else if (isNaN(sel)) {\n  result = {\n    status: 'error',\n    message: `Ups, “${raw}” no es un número. Por favor ingresa 1 o 2.`\n  };\n} else if (!Number.isInteger(sel)) {\n  result = {\n    status: 'error',\n    message: `La selección debe ser un número entero.`\n  };\n} else if (sel !== 1 && sel !== 2) {\n  result = {\n    status: 'error',\n    message: `La opción ${sel} es inválida. Sólo se permite 1 o 2.`\n  };\n} else {\n  // 3. Todo OK\n  result = {\n    status: 'success',\n    selection: sel\n  };\n}\n\n// 4. Devolver el resultado para nodos siguientes\nreturn [\n  {\n    json: result\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3140,
        440
      ],
      "id": "674d2d52-b77a-4120-aba8-5cd54cceba2a",
      "name": "Code6"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "238935cb-8dfd-4cff-b235-bb110088cbe5",
              "leftValue": "={{ $json.status }}",
              "rightValue": "error",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3360,
        440
      ],
      "id": "8770a27a-accc-49c7-8778-1b5eda74ba7f",
      "name": "estatus error?"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        4160,
        520
      ],
      "id": "0dc394a4-240c-4bc7-b138-da1fbd7a2181",
      "name": "No Operation, do nothing3"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "8fc3ead6-cfc0-411d-9e69-eeae4bf8a6ef",
              "leftValue": "={{ $json.selection }}",
              "rightValue": 2,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3480,
        780
      ],
      "id": "945d3f3c-f8f9-4261-b9b7-e7eda4abb429",
      "name": "opcion es 1?"
    },
    {
      "parameters": {
        "content": "## Agregar funcvionalidad para atencion a cliente "
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        3660,
        920
      ],
      "typeVersion": 1,
      "id": "49a937db-673f-4f37-a90a-b68601e40a65",
      "name": "Sticky Note3"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        3700,
        1140
      ],
      "id": "8681ae66-d40f-4216-8ed0-4fdfdc579335",
      "name": "No Operation, do nothing4"
    },
    {
      "parameters": {
        "content": "## menú sobre información\n\nGracias por solicitar información, ¿Sobre que necesitas saber?\\n\\n1️⃣ Ubicación\\n2️⃣ Costos \n3️⃣ Horario Extendido\n4️⃣ Programa Bilingüe\n5️⃣ Contáctame 📲\n\n6️⃣ Gracias, ya estoy hablando con un asesor ✅",
        "height": 400,
        "width": 740
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        5460,
        -3140
      ],
      "typeVersion": 1,
      "id": "1a8fb44f-c0ed-4ed0-9cb4-ce3aad2b2664",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "content": "## Menú sobre información y dias de cita disponible",
        "height": 260,
        "width": 1140
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        5440,
        -2560
      ],
      "typeVersion": 1,
      "id": "790ec6fc-6482-401b-b61c-2592e4847711",
      "name": "Sticky Note5"
    }
  ],
  "connections": {
    "Set Variables": {
      "main": [
        [
          {
            "node": "MongoDB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Auth Guardian": {
      "main": [
        [
          {
            "node": "IF - Auth Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF - Auth Success": {
      "main": [
        [],
        []
      ]
    },
    "Main Logic Placeholder": {
      "main": [
        []
      ]
    },
    "MongoDB": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "typing indicator1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "typing indicator2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "MongoDB1": {
      "main": [
        [
          {
            "node": "MongoDB2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "MongoDB1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "WhatsApp Trigger": {
      "main": [
        [
          {
            "node": "Variables Wp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "MongoDB2": {
      "main": [
        [
          {
            "node": "Edit Fields2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "Code2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields2": {
      "main": [
        [
          {
            "node": "Code2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch1": {
      "main": [
        [
          {
            "node": "Error mensaje de voz",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "error documento",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "error imagen",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "error video",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Variables",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Variables",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "typing indicator1": {
      "main": [
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "typing indicator2": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Variables Wp": {
      "main": [
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If9": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If10": {
      "main": [
        []
      ]
    },
    "Edit Fields3": {
      "main": [
        [
          {
            "node": "MongoDB4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "MongoDB4": {
      "main": [
        []
      ]
    },
    "Code1": {
      "main": [
        [
          {
            "node": "Edit Fields4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields4": {
      "main": [
        [
          {
            "node": "MongoDB5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "MongoDB5": {
      "main": [
        [
          {
            "node": "Edit Fields3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Mensaje menu inicial",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "obtenemos la respuesta del menu inicial",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "obtenemos la respuesta del menu inicial1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "revisamos si viene boton de menu anterior",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "obtenemos la respuesta del menu costos",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "tomamos la seleccion del usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "flujo de actualización base de datos": {
      "main": [
        [
          {
            "node": "Code1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "revisamos si ya existia": {
      "main": [
        [
          {
            "node": "Edit Fields5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields5": {
      "main": [
        [
          {
            "node": "Execute Workflow",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code2": {
      "main": [
        [
          {
            "node": "If9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code3": {
      "main": [
        [
          {
            "node": "verificamos que la seleccion sea valida",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "obtenemos la respuesta del menu inicial": {
      "main": [
        [
          {
            "node": "Code3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "verificamos que la seleccion sea valida": {
      "main": [
        [
          {
            "node": "Switch2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error seleccion menu invalida",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Error seleccion menu invalida": {
      "main": [
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch2": {
      "main": [
        [
          {
            "node": "Mensaje menu información",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "envio de mensaje ubicación": {
      "main": [
        [
          {
            "node": "body datos ubicacion",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "body datos ubicacion": {
      "main": [
        [
          {
            "node": "Execute Workflow1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "body datos costos": {
      "main": [
        [
          {
            "node": "Execute Workflow2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "body datos costos1": {
      "main": [
        [
          {
            "node": "Execute Workflow3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "body datos costos2": {
      "main": [
        [
          {
            "node": "Execute Workflow4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "body datos costos3": {
      "main": [
        [
          {
            "node": "Execute Workflow5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code4": {
      "main": [
        [
          {
            "node": "verificamos que la seleccion sea valida1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "verificamos que la seleccion sea valida1": {
      "main": [
        [
          {
            "node": "validamos si se selecciono menu anterior desde costos",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error seleccion menu invalida1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Error seleccion menu invalida1": {
      "main": [
        [
          {
            "node": "No Operation, do nothing1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "obtenemos la respuesta del menu costos": {
      "main": [
        [
          {
            "node": "Code4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "validamos si se selecciono menu anterior desde costos": {
      "main": [
        [
          {
            "node": "Mensaje menu inicial",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Switch3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch3": {
      "main": [
        [
          {
            "node": "info costo maternal",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "info costo pre escolar",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "info costo primaria",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "info costo secundaria",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "info costo bachillerato",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "info costo maternal": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "info costo pre escolar": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "info costo primaria": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "info costo secundaria": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "info costo bachillerato": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "envio de mensaje contacto costos": {
      "main": [
        [
          {
            "node": "body datos contacto costos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "body datos contacto costos": {
      "main": [
        [
          {
            "node": "Execute Workflow6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields6": {
      "main": [
        [
          {
            "node": "Execute Workflow7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Error mensaje contacto costos": {
      "main": [
        [
          {
            "node": "No Operation, do nothing3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensaje menu inicial": {
      "main": [
        [
          {
            "node": "revisamos si ya existia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensaje menu información": {
      "main": [
        [
          {
            "node": "body datos menu información",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "body datos menu información": {
      "main": [
        [
          {
            "node": "Execute Workflow8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code5": {
      "main": [
        [
          {
            "node": "verificamos que la seleccion sea valida2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "obtenemos la respuesta del menu inicial1": {
      "main": [
        [
          {
            "node": "Code5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "verificamos que la seleccion sea valida2": {
      "main": [
        [
          {
            "node": "revisamos que ya esta hablando con alguien",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error seleccion menu invalida2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Error seleccion menu invalida2": {
      "main": [
        [
          {
            "node": "No Operation, do nothing2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "No Operation, do nothing2": {
      "main": [
        []
      ]
    },
    "Switch4": {
      "main": [
        [
          {
            "node": "envio de mensaje ubicación",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "envio de mensaje costo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "envio de mensaje horario",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "envio de mensaje bilingüe",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "envio de mensaje contactame",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "envio de mensaje costo": {
      "main": [
        [
          {
            "node": "body datos costos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "envio de mensaje horario": {
      "main": [
        [
          {
            "node": "body datos costos1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "envio de mensaje bilingüe": {
      "main": [
        [
          {
            "node": "body datos costos2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "envio de mensaje contactame": {
      "main": [
        [
          {
            "node": "body datos costos3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "revisamos que ya esta hablando con alguien": {
      "main": [
        [
          {
            "node": "Error seleccion menu invalida3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Switch4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "body datos costos4": {
      "main": [
        [
          {
            "node": "Execute Workflow9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Error seleccion menu invalida3": {
      "main": [
        [
          {
            "node": "body datos costos4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Mensaje menu información1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensaje menu información1": {
      "main": [
        [
          {
            "node": "menu principal4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "body datos menu información1": {
      "main": [
        [
          {
            "node": "Execute Workflow10",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "menu principal4": {
      "main": [
        [
          {
            "node": "body datos menu información1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "revisamos si viene boton de menu anterior": {
      "main": [
        [
          {
            "node": "Mensaje menu inicial",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP Request2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request2": {
      "main": [
        [
          {
            "node": "datos para seleccionar dia de cita",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "datos para seleccionar dia de cita": {
      "main": [
        [
          {
            "node": "obtenemos el slot solicitado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "obtenemos el slot solicitado": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "error de seleccion de dia",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "guardamos la cita",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "guardamos la cita": {
      "main": [
        [
          {
            "node": "verificamos que halla un error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "verificamos que halla un error": {
      "main": [
        [
          {
            "node": "error usuario no registrado",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "error usuario no registrado1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "body datos costos5": {
      "main": [
        [
          {
            "node": "Execute Workflow11",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "error usuario no registrado": {
      "main": [
        [
          {
            "node": "body datos costos5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "body datos costos6": {
      "main": [
        [
          {
            "node": "Execute Workflow12",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "error usuario no registrado1": {
      "main": [
        [
          {
            "node": "body datos costos6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "envio de mensaje contacto costos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "tomamos la seleccion del usuario": {
      "main": [
        [
          {
            "node": "Code6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code6": {
      "main": [
        [
          {
            "node": "estatus error?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "estatus error?": {
      "main": [
        [
          {
            "node": "Error mensaje contacto costos",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "opcion es 1?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "opcion es 1?": {
      "main": [
        [
          {
            "node": "Error seleccion menu invalida3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": null,
  "pinData": {},
  "versionId": "1cfd47cb-4ce9-4bc7-97cc-528a07bc8cc8",
  "triggerCount": 1,
  "shared": [
    {
      "createdAt": "2025-06-24T22:28:19.616Z",
      "updatedAt": "2025-06-24T22:28:19.616Z",
      "role": "workflow:owner",
      "workflowId": "PetXIW4fDRVoHgK5",
      "projectId": "BsYMJSPwury6TiTn",
      "project": {
        "createdAt": "2025-06-06T20:24:22.277Z",
        "updatedAt": "2025-06-06T21:09:46.835Z",
        "id": "BsYMJSPwury6TiTn",
        "name": "adolfo huerta <adolfocuentas123@gmail.com>",
        "type": "personal",
        "icon": null,
        "description": null,
        "projectRelations": [
          {
            "createdAt": "2025-06-06T20:24:22.278Z",
            "updatedAt": "2025-06-06T20:24:22.278Z",
            "role": "project:personalOwner",
            "userId": "f9268337-0922-4cba-994c-bf6b40332731",
            "projectId": "BsYMJSPwury6TiTn",
            "user": {
              "createdAt": "2025-06-06T20:24:22.275Z",
              "updatedAt": "2025-06-18T03:10:17.057Z",
              "id": "f9268337-0922-4cba-994c-bf6b40332731",
              "email": "adolfocuentas123@gmail.com",
              "firstName": "adolfo",
              "lastName": "huerta",
              "personalizationAnswers": {
                "version": "v4",
                "personalization_survey_submitted_at": "2025-06-06T21:09:59.993Z",
                "personalization_survey_n8n_version": "1.92.2",
                "companySize": "<20",
                "companyType": "saas",
                "role": "business-owner",
                "reportedSource": "twitter"
              },
              "settings": {
                "firstSuccessfulWorkflowId": "k6PApGOzpLKtnZ0q",
                "userActivated": true,
                "userActivatedAt": 1749594629341,
                "npsSurvey": {
                  "responded": true,
                  "lastShownAt": 1750216203399
                }
              },
              "role": "global:member",
              "disabled": false,
              "mfaEnabled": false,
              "isPending": false
            }
          }
        ]
      }
    }
  ],
  "tags": [
    {
      "createdAt": "2025-07-03T15:43:40.294Z",
      "updatedAt": "2025-07-03T15:43:40.294Z",
      "id": "H4J6yXkqR5NnyS8H",
      "name": "prod"
    }
  ]
}